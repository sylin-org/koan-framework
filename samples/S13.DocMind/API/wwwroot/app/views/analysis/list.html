<div class="container-fluid py-4" ng-controller="AnalysisController">
    <div ng-if="loading" class="d-flex justify-content-center align-items-center" style="min-height: 320px;">
        <div class="text-center text-muted">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-3">Loading manual analysis sessions…</p>
        </div>
    </div>

    <div ng-if="!loading">
        <div class="row align-items-center mb-4">
            <div class="col">
                <h1 class="h3 mb-1">Manual Analysis Sessions</h1>
                <p class="text-muted mb-0">Curate document sets, run synthesis prompts, and review cross-document findings.</p>
            </div>
            <div class="col-auto">
                <button class="btn btn-outline-secondary me-2" ng-click="refresh()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
                <button class="btn btn-primary" ng-click="createSession()">
                    <i class="bi bi-plus-circle"></i> New Session
                </button>
            </div>
        </div>

        <div class="row row-cols-1 row-cols-md-4 g-3 mb-4">
            <div class="col">
                <div class="card border-primary h-100">
                    <div class="card-body">
                        <h6 class="card-subtitle text-primary text-uppercase">Total Sessions</h6>
                        <h2 class="card-title fw-bold">{{stats.totalSessions || 0}}</h2>
                        <p class="card-text text-muted small mb-0">All manual analysis sessions</p>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card border-success h-100">
                    <div class="card-body">
                        <h6 class="card-subtitle text-success text-uppercase">Completed</h6>
                        <h2 class="card-title fw-bold">{{stats.completedSessions || 0}}</h2>
                        <p class="card-text text-muted small mb-0">Sessions with completed synthesis</p>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card border-warning h-100">
                    <div class="card-body">
                        <h6 class="card-subtitle text-warning text-uppercase">In Progress</h6>
                        <h2 class="card-title fw-bold">{{stats.runningSessions || 0}}</h2>
                        <p class="card-text text-muted small mb-0">Currently running or queued</p>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card border-info h-100">
                    <div class="card-body">
                        <h6 class="card-subtitle text-info text-uppercase">Draft</h6>
                        <h2 class="card-title fw-bold">{{stats.draftSessions || 0}}</h2>
                        <p class="card-text text-muted small mb-0">Sessions awaiting configuration</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3 align-items-center">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" placeholder="Search sessions…" ng-model="search">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-secondary" ng-class="{'active': statusFilter === 'all'}" ng-click="setStatusFilter('all')">All</button>
                            <button type="button" class="btn btn-outline-secondary" ng-class="{'active': statusFilter === 'completed'}" ng-click="setStatusFilter('completed')">Completed</button>
                            <button type="button" class="btn btn-outline-secondary" ng-class="{'active': statusFilter === 'running'}" ng-click="setStatusFilter('running')">Running</button>
                            <button type="button" class="btn btn-outline-secondary" ng-class="{'active': statusFilter === 'draft'}" ng-click="setStatusFilter('draft')">Draft</button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" ng-model="sortKey" ng-change="setSort(sortKey)">
                            <option value="lastRunAt">Last Run</option>
                            <option value="createdAt">Created Date</option>
                            <option value="title">Title</option>
                            <option value="documents">Documents</option>
                            <option value="confidence">Confidence</option>
                        </select>
                    </div>
                    <div class="col-md-2 text-end">
                        <button class="btn btn-outline-secondary" ng-click="setSort(sortKey)">
                            <i class="{{getSortIcon(sortKey)}}"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div ng-if="filteredSessions.length === 0" class="text-center py-5 text-muted">
            <i class="bi bi-collection display-4"></i>
            <p class="mt-3 mb-1">No manual analysis sessions yet.</p>
            <p class="mb-0">Create a session to curate documents and run cross-document synthesis.</p>
        </div>

        <div class="card" ng-if="filteredSessions.length > 0">
            <div class="table-responsive">
                <table class="table align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Session</th>
                            <th style="width: 140px;">Documents</th>
                            <th style="width: 180px;">Last Run</th>
                            <th style="width: 140px;">Confidence</th>
                            <th style="width: 140px;">Status</th>
                            <th style="width: 220px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="session in filteredSessions">
                            <td>
                                <div class="fw-semibold">{{session.title}}</div>
                                <div class="text-muted small">{{primaryFinding(session) || 'No synthesis available yet.'}}</div>
                            </td>
                            <td>
                                <span class="badge bg-light text-dark"><i class="bi bi-files"></i> {{session.documents && session.documents.length ? session.documents.length : 0}}</span>
                            </td>
                            <td>
                                <div>{{formatDate(session.lastRunAt || session.updatedAt)}}</div>
                                <div class="text-muted small">Created {{formatDate(session.createdAt)}}</div>
                            </td>
                            <td>
                                <span class="badge {{getConfidenceClass(session.lastSynthesis && session.lastSynthesis.confidence)}}">
                                    {{formatConfidenceScore(session.lastSynthesis && session.lastSynthesis.confidence)}}
                                </span>
                            </td>
                            <td>
                                <span class="{{statusClass(session.status)}}">{{statusLabel(session.status)}}</span>
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-primary" ng-click="viewSession(session)">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" ng-click="editSession(session)">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" ng-click="runSession(session)">
                                        <i class="bi bi-play-circle"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" ng-click="deleteSession(session)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
