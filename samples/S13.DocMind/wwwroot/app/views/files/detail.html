<div class="container-fluid py-4" ng-controller="FileDetailController">
    <!-- Loading State -->
    <div ng-if="loading" class="d-flex justify-content-center align-items-center" style="min-height: 400px;">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading file details...</p>
        </div>
    </div>

    <!-- File Details Content -->
    <div ng-if="!loading && file">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <div class="d-flex align-items-center mb-2">
                    <button class="btn btn-outline-secondary me-3" ng-click="goBack()">
                        <i class="bi bi-arrow-left"></i>
                    </button>
                    <div class="flex-grow-1">
                        <h1 class="h2 mb-1">{{file.displayName}}</h1>
                        <p class="text-muted mb-0">
                            {{formatFileSize(file.fileSize)}} • Uploaded {{formatDate(file.createdAt)}}
                        </p>
                    </div>
                    <div class="text-end">
                        <span class="badge {{getStateClass(file)}} fs-6">{{getStateLabel(file)}}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row mb-4">
            <div class="col">
                <div class="btn-group me-3" role="group">
                    <button class="btn btn-primary" ng-click="downloadFile()">
                        <i class="bi bi-download me-2"></i>Download
                    </button>
                    <button class="btn btn-outline-danger" ng-click="deleteFile()">
                        <i class="bi bi-trash me-2"></i>Delete
                    </button>
                </div>

                <div class="btn-group" role="group" ng-if="canTriggerAnalysis()">
                    <button class="btn btn-success" ng-click="triggerAnalysis()" ng-disabled="analysisInProgress">
                        <span ng-if="!analysisInProgress">
                            <i class="bi bi-play-circle me-2"></i>Start Analysis
                        </span>
                        <span ng-if="analysisInProgress">
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            Starting Analysis...
                        </span>
                    </button>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- File Information -->
            <div class="col-lg-4 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="{{getFileIcon(file)}} me-2"></i>File Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            <dt class="col-sm-5">File Name:</dt>
                            <dd class="col-sm-7">
                                <span class="text-break">{{file.displayName}}</span>
                            </dd>

                            <dt class="col-sm-5" ng-if="file.userFileName !== file.fileName">Original Name:</dt>
                            <dd class="col-sm-7" ng-if="file.userFileName !== file.fileName">
                                <span class="text-break">{{file.userFileName}}</span>
                            </dd>

                            <dt class="col-sm-5">File Size:</dt>
                            <dd class="col-sm-7">{{formatFileSize(file.fileSize)}}</dd>

                            <dt class="col-sm-5">Upload Date:</dt>
                            <dd class="col-sm-7">{{formatDate(file.createdAt)}}</dd>

                            <dt class="col-sm-5">Status:</dt>
                            <dd class="col-sm-7">
                                <span class="badge {{getStateClass(file)}}">{{getStateLabel(file)}}</span>
                            </dd>

                            <dt class="col-sm-5">Content Type:</dt>
                            <dd class="col-sm-7">
                                <span class="font-monospace small">{{file.contentType || 'Unknown'}}</span>
                            </dd>

                            <dt class="col-sm-5" ng-if="file.notes">Notes:</dt>
                            <dd class="col-sm-7" ng-if="file.notes">{{file.notes}}</dd>
                        </dl>
                    </div>
                </div>
            </div>

            <!-- Document Type Assignment -->
            <div class="col-lg-8 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-tags me-2"></i>Document Type
                        </h5>
                    </div>
                    <div class="card-body">
                        <div ng-if="file.typeId" class="mb-3">
                            <div class="alert alert-success">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-check-circle-fill me-2"></i>
                                    <strong>{{getTypeName(file.typeId)}}</strong>
                                </div>
                                <small class="d-block mt-1 text-muted">
                                    Document type has been assigned
                                </small>
                            </div>
                        </div>

                        <div ng-if="canAssignType()">
                            <p class="text-muted mb-3">
                                Assign a document type to enable automated analysis and processing.
                            </p>

                            <div class="row g-3">
                                <div class="col-md-8">
                                    <select class="form-select" ng-model="selectedTypeId">
                                        <option value="">Select a document type...</option>
                                        <option ng-repeat="type in documentTypes" ng-if="type.id" value="{{type.id}}">
                                            {{type.name}}
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-primary w-100" ng-click="assignType()"
                                            ng-disabled="!selectedTypeId || assigningType">
                                        <span ng-if="!assigningType">
                                            <i class="bi bi-tag me-2"></i>Assign Type
                                        </span>
                                        <span ng-if="assigningType">
                                            <span class="spinner-border spinner-border-sm me-2"></span>
                                            Assigning...
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div ng-if="!canAssignType() && !file.typeId" class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            Document type can only be assigned to uploaded files.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis Results -->
        <div class="row" ng-if="hasAnalyses()">
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-graph-up me-2"></i>Analysis Results
                            <span class="badge bg-secondary ms-2">{{analyses.length}}</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div ng-repeat="analysis in analyses" class="border rounded p-3 mb-3"
                             ng-class="{'border-0 mb-0': $last}">
                            <!-- Analysis Header -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h6 class="mb-1">Analysis #{{$index + 1}}</h6>
                                    <small class="text-muted">
                                        {{formatDate(analysis.createdAt)}} •
                                        Confidence: <span class="{{getConfidenceClass(analysis)}}">
                                            {{formatConfidenceScore(analysis.confidenceScore)}}
                                        </span>
                                    </small>
                                </div>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-primary" ng-click="viewAnalysis(analysis)">
                                        <i class="bi bi-eye"></i> View Details
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" ng-click="deleteAnalysis(analysis)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Analysis Content -->
                            <div class="row">
                                <div class="col-md-6" ng-if="analysis.summary">
                                    <h6>Summary</h6>
                                    <p class="text-muted small">{{analysis.summary}}</p>
                                </div>
                                <div class="col-md-6" ng-if="analysis.extractedContext">
                                    <h6>Key Information</h6>
                                    <p class="text-muted small">{{analysis.extractedContext}}</p>
                                </div>
                            </div>

                            <!-- Structured Data Preview -->
                            <div ng-if="analysis.structuredData && Object.keys(analysis.structuredData).length > 0">
                                <h6>Extracted Data</h6>
                                <div class="row">
                                    <div class="col-md-6" ng-repeat="(key, value) in analysis.structuredData | limitTo: 4">
                                        <small class="text-muted d-block">{{key}}</small>
                                        <div class="fw-medium">{{value}}</div>
                                    </div>
                                </div>
                                <div ng-if="Object.keys(analysis.structuredData).length > 4" class="mt-2">
                                    <button class="btn btn-sm btn-outline-secondary" ng-click="viewAnalysis(analysis)">
                                        View {{Object.keys(analysis.structuredData).length - 4}} more fields...
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- No Analysis State -->
        <div class="row" ng-if="!hasAnalyses() && file.typeId">
            <div class="col">
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="bi bi-graph-up display-4 text-muted mb-3"></i>
                        <h5 class="text-muted">No Analysis Available</h5>
                        <p class="text-muted mb-3">
                            This document has a type assigned but hasn't been analyzed yet.
                        </p>
                        <button class="btn btn-success" ng-click="triggerAnalysis()" ng-disabled="analysisInProgress"
                                ng-if="canTriggerAnalysis()">
                            <span ng-if="!analysisInProgress">
                                <i class="bi bi-play-circle me-2"></i>Start Analysis
                            </span>
                            <span ng-if="analysisInProgress">
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                Starting Analysis...
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- File Not Found -->
    <div ng-if="!loading && !file" class="text-center py-5">
        <i class="bi bi-file-earmark-x display-1 text-muted mb-3"></i>
        <h3 class="text-muted">File Not Found</h3>
        <p class="text-muted">The requested file could not be found.</p>
        <button class="btn btn-primary" ng-click="goBack()">
            <i class="bi bi-arrow-left me-2"></i>Back to Files
        </button>
    </div>
</div>