<div class="layout" ng-controller="DashboardController as vm" ng-init="vm.$onInit()">
  <section class="card banner">
    <div class="actions">
      <button class="btn" ng-click="vm.refreshNow()">Refresh</button>
      <button class="btn" ng-click="vm.toggleAutoRefresh()">
        {{ vm.autoRefresh ? 'Pause Auto-Refresh' : 'Resume Auto-Refresh' }}
      </button>
      <span class="timestamp" ng-if="vm.lastUpdated">Last updated: {{ vm.lastUpdated | date:'mediumTime' }}</span>
    </div>
    <div class="status" ng-if="vm.options">
      <span class="pill" ng-class="{ 'enabled': vm.options.aiAssistEnabled, 'disabled': !vm.options.aiAssistEnabled }">
        AI Assist {{ vm.options.aiAssistEnabled ? ('ON (' + vm.options.aiAssistModel + ')') : 'OFF' }}
      </span>
      <span class="pill">Threshold {{ vm.options.aiConfidenceThreshold | percent:1 }}</span>
    </div>
  </section>

  <section class="card" ng-if="vm.loading">
    <h2>Loading…</h2>
  </section>

  <section class="card error" ng-if="vm.error">
    <h2>Error</h2>
    <p>{{ vm.error }}</p>
  </section>

  <section class="card stats" ng-if="!vm.loading && !vm.error">
    <div class="stat">
      <h3>Canonical</h3>
      <p>{{ vm.metrics.canonicalCount || 0 }}</p>
    </div>
    <div class="stat">
      <h3>Cache Entries</h3>
      <p>{{ vm.metrics.cacheCount || 0 }}</p>
    </div>
    <div class="stat">
      <h3>Parked</h3>
      <p>{{ vm.metrics.parkedCount || 0 }}</p>
    </div>
    <div class="stat">
      <h3>AI Assist Usage</h3>
      <p>{{ vm.aiAssistCount }} <small>({{ vm.aiAssistRatio | percent:1 }})</small></p>
    </div>
  </section>

  <section class="card" ng-if="vm.canonical.length">
    <h2>Recent Canonical Locations</h2>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Display</th>
          <th>Confidence</th>
          <th>Top Tokens</th>
          <th>Sources</th>
          <th>AI Assist</th>
        </tr>
      </thead>
      <tbody>
        <tr ng-repeat="c in vm.canonical">
          <td>{{ c.id }}</td>
          <td>{{ c.displayName }}</td>
          <td>{{ c.attributes.confidence | number:2 }}</td>
          <td>
            <span ng-repeat="pair in c.topTokens" class="pill">{{ pair[0] }}: {{ pair[1] }}</span>
          </td>
          <td>
            <span ng-repeat="s in c.attributes.sources track by $index" class="pill">{{ s }}</span>
          </td>
          <td>
            <span ng-if="c.aiAssistUsed" class="pill enabled">{{ c.aiAssistModel || 'auto' }}</span>
            <span ng-if="!c.aiAssistUsed" class="pill disabled">–</span>
          </td>
        </tr>
      </tbody>
    </table>
  </section>

  <section class="card" ng-if="vm.cache.length">
    <h2>Cache Snapshot</h2>
    <table>
      <thead>
        <tr>
          <th>Hash</th>
          <th>Address</th>
          <th>Confidence</th>
        </tr>
      </thead>
      <tbody>
        <tr ng-repeat="cache in vm.cache">
          <td><code>{{ cache.id | limitTo:12 }}</code></td>
          <td>{{ cache.normalizedAddress }}</td>
          <td>{{ cache.confidence | number:2 }}</td>
        </tr>
      </tbody>
    </table>
  </section>

  <section class="card" ng-if="vm.parked.length">
    <h2>Parked Records</h2>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Reason</th>
          <th>Source</th>
          <th>Data</th>
        </tr>
      </thead>
      <tbody>
        <tr ng-repeat="parked in vm.parked">
          <td>{{ parked.id }}</td>
          <td>{{ parked.reasonCode }}</td>
          <td>{{ parked.data.sourceSystem }} / {{ parked.data.sourceId }}</td>
          <td>{{ parked.data.address }}</td>
        </tr>
      </tbody>
    </table>
  </section>
</div>
