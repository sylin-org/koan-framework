<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Koan TestProvider - Sign in</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script>tailwind.config = { theme: { extend: { colors: { slate: { 950: '#020617' } } } } };</script>
  <style>
    .card { background: linear-gradient(180deg, rgba(15,23,42,1) 0%, rgba(2,6,23,1) 100%); }
    .kv-grid { display: grid; grid-template-columns: 1fr 1fr auto; gap: 0.5rem; }
    .recent-pill {
      transition: all 0.2s ease;
    }
    .recent-pill:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(168, 85, 247, 0.4);
    }
  </style>
</head>
<body class="bg-slate-950 text-white min-h-screen flex flex-col">
  <header class="bg-slate-900 border-b border-slate-800">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center space-x-3" title="Home">
          <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg flex items-center justify-center">
            <i class="fas fa-satellite-dish text-white text-sm"></i>
          </div>
          <h1 class="text-lg font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">Koan - Sign in</h1>
        </div>
      </div>
    </div>
  </header>

  <main class="flex-1 flex items-center justify-center px-4 py-10">
    <div class="w-full max-w-2xl space-y-4">
      <!-- Recent Logins Section -->
      <div id="recentLoginsSection" class="hidden">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <i class="fas fa-clock text-purple-400 text-sm"></i>
            <span class="text-sm font-medium text-gray-300">Recent logins</span>
          </div>
          <button id="clearAllRecent" class="text-xs px-3 py-1 text-gray-400 hover:text-red-400 hover:bg-slate-900/50 rounded transition-colors">
            <i class="fas fa-trash-alt mr-1"></i>Clear all
          </button>
        </div>
        <div id="recentLoginsContainer" class="flex gap-2 overflow-x-auto pb-2 pt-1"></div>
      </div>

      <!-- Manual Sign-in Form -->
      <div class="card rounded-2xl border border-slate-800 shadow-2xl p-6">
      <div class="flex items-center gap-3 mb-4">
        <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl flex items-center justify-center">
          <i class="fa-regular fa-user text-white"></i>
        </div>
        <div>
          <div class="text-xl font-semibold">Sign in</div>
          <div class="text-sm text-gray-400">Development Test Provider</div>
        </div>
      </div>

      <form id="f" class="space-y-4">
        <input type="hidden" id="client_id" />
        <input type="hidden" id="redirect_uri" />

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label for="u" class="block text-sm text-gray-300 mb-1">Name</label>
            <input id="u" class="w-full bg-slate-900 text-white rounded-lg px-3 py-2 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Jane Doe" />
          </div>
          <div>
            <label for="e" class="block text-sm text-gray-300 mb-1">Email</label>
            <input id="e" type="email" class="w-full bg-slate-900 text-white rounded-lg px-3 py-2 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="jane@example.com" />
          </div>
        </div>

        <details class="rounded-lg border border-slate-800 bg-slate-900/50 p-3">
          <summary class="cursor-pointer select-none">Advanced (roles, permissions, claims)</summary>
          <div class="mt-3 space-y-3">
            <div>
              <label for="roles" class="block text-sm text-gray-300 mb-1">Roles (comma separated)</label>
              <input id="roles" class="w-full bg-slate-900 text-white rounded-lg px-3 py-2 border border-slate-700" placeholder="reader,author,admin" />
            </div>
            <div>
              <label for="perms" class="block text-sm text-gray-300 mb-1">Permissions (comma separated)</label>
              <input id="perms" class="w-full bg-slate-900 text-white rounded-lg px-3 py-2 border border-slate-700" placeholder="content:write,posts:delete" />
            </div>
            <div>
              <div class="flex items-center justify-between">
                <label class="text-sm text-gray-300">Claims</label>
                <button type="button" id="addClaim" class="text-xs px-2 py-1 bg-slate-800 hover:bg-slate-700 rounded">Add row</button>
              </div>
              <div id="claimsGrid" class="kv-grid mt-2"></div>
            </div>
          </div>
        </details>

        <div class="flex gap-2">
          <button type="submit" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg font-medium">Continue</button>
          <button type="button" id="clear" class="px-3 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg">Clear</button>
          <button type="button" id="export" class="px-3 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg">Export persona</button>
          <label class="px-3 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg cursor-pointer">
            Import persona<input id="import" type="file" accept="application/json" class="hidden" />
          </label>
        </div>
        <p class="text-xs text-gray-500">Local-only auth for development. Do not enable in production.</p>
      </form>
      </div>
    </div>
  </main>

  <footer class="border-t border-slate-800 py-6 text-center text-sm text-gray-500">
    Powered by Koan Â· TestProvider
  </footer>

  <script>
    const qs = new URLSearchParams(location.search);
    const u = document.getElementById('u');
    const e = document.getElementById('e');
    const roles = document.getElementById('roles');
    const perms = document.getElementById('perms');
    const claimsGrid = document.getElementById('claimsGrid');
    const addRowBtn = document.getElementById('addClaim');
    const persist = true; // always persist for now; can be toggled via options later
    const MAX_RECENT_LOGINS = 5;

    // Recent Logins Management
    function getRecentLogins() {
      const raw = localStorage.getItem('tp_recent_logins');
      return raw ? JSON.parse(raw) : [];
    }

    function saveRecentLogin(persona) {
      if (!persona.name || !persona.email) return;

      let recents = getRecentLogins();

      // Remove duplicate (same name+email combo)
      recents = recents.filter(r => !(r.name === persona.name && r.email === persona.email));

      // Add to front
      recents.unshift({
        name: persona.name,
        email: persona.email,
        roles: persona.roles,
        permissions: persona.permissions,
        claims: persona.claims,
        timestamp: Date.now()
      });

      // Keep only last 5
      recents = recents.slice(0, MAX_RECENT_LOGINS);

      localStorage.setItem('tp_recent_logins', JSON.stringify(recents));
    }

    function clearAllRecentLogins() {
      localStorage.removeItem('tp_recent_logins');
      renderRecentLogins();
    }

    function renderRecentLogins() {
      const recents = getRecentLogins();
      const section = document.getElementById('recentLoginsSection');
      const container = document.getElementById('recentLoginsContainer');

      if (recents.length === 0) {
        section.classList.add('hidden');
        return;
      }

      section.classList.remove('hidden');
      container.innerHTML = '';

      for (const persona of recents) {
        const pill = document.createElement('button');
        pill.type = 'button';
        pill.className = 'recent-pill flex-shrink-0 bg-slate-900 border border-slate-700 hover:border-purple-500 rounded-lg px-4 py-3 text-left min-w-[200px]';

        const rolesBadge = persona.roles && persona.roles.length > 0
          ? `<span class="inline-block mt-1 text-xs px-2 py-0.5 bg-purple-500/20 text-purple-300 rounded">${persona.roles.length} role${persona.roles.length > 1 ? 's' : ''}</span>`
          : '';

        pill.innerHTML = `
          <div class="font-medium text-white truncate">${escapeHtml(persona.name)}</div>
          <div class="text-sm text-gray-400 truncate">${escapeHtml(persona.email)}</div>
          ${rolesBadge}
        `;

        pill.onclick = () => quickLogin(persona);
        container.appendChild(pill);
      }
    }

    function quickLogin(persona) {
      // Populate form with persona
      u.value = persona.name || '';
      e.value = persona.email || '';
      roles.value = (persona.roles || []).join(',');
      perms.value = (persona.permissions || []).join(',');

      // Populate claims
      claimsGrid.innerHTML = '';
      if (persona.claims && persona.claims.length > 0) {
        for (const kv of persona.claims) addRow(kv.key, kv.value);
      } else {
        addRow('', '');
      }

      // Auto-submit
      document.getElementById('f').requestSubmit();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function loadDefaults() {
      u.value = localStorage.getItem('tp_u')||'';
      e.value = localStorage.getItem('tp_e')||'';
      roles.value = localStorage.getItem('tp_roles')||'reader';
      perms.value = localStorage.getItem('tp_perms')||'';
      const raw = localStorage.getItem('tp_claims');
      const arr = raw ? JSON.parse(raw) : [];
      claimsGrid.innerHTML = '';
      for (const kv of arr) addRow(kv.key, kv.value);
      if (arr.length === 0) addRow('', '');
      document.getElementById('client_id').value = qs.get('client_id')||'';
      document.getElementById('redirect_uri').value = qs.get('redirect_uri')||'';
    }

    function addRow(k='', v='') {
      const wrap = document.createElement('div');
      wrap.className = 'contents';
      const key = document.createElement('input');
      key.className = 'bg-slate-900 text-white rounded-lg px-3 py-2 border border-slate-700';
      key.placeholder = 'claim type (e.g., department or Koan.capability)';
      key.value = k;
      const val = document.createElement('input');
      val.className = 'bg-slate-900 text-white rounded-lg px-3 py-2 border border-slate-700';
      val.placeholder = 'value';
      val.value = v;
      const rm = document.createElement('button');
      rm.type = 'button'; rm.className = 'px-2 py-1 bg-slate-800 hover:bg-slate-700 rounded'; rm.textContent = 'Remove';
      rm.onclick = () => wrap.remove();
      wrap.appendChild(key); wrap.appendChild(val); wrap.appendChild(rm);
      claimsGrid.appendChild(wrap);
    }

    addRowBtn.onclick = () => addRow('', '');

    document.getElementById('clear').onclick = () => {
      localStorage.removeItem('tp_u');
      localStorage.removeItem('tp_e');
      localStorage.removeItem('tp_roles');
      localStorage.removeItem('tp_perms');
      localStorage.removeItem('tp_claims');
      loadDefaults();
    };

    document.getElementById('export').onclick = () => {
      const data = personaFromUi();
      const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'testprovider-persona.json';
      a.click();
      URL.revokeObjectURL(a.href);
    };

    document.getElementById('import').onchange = async (ev) => {
      const file = ev.target.files[0]; if (!file) return;
      const txt = await file.text();
      const data = JSON.parse(txt);
      u.value = data.name||'';
      e.value = data.email||'';
      roles.value = (data.roles||[]).join(',');
      perms.value = (data.permissions||[]).join(',');
      claimsGrid.innerHTML = '';
      if (data.claims && Array.isArray(data.claims)) {
        for (const kv of data.claims) addRow(kv.key, kv.value);
      } else if (data.claims && typeof data.claims === 'object') {
        for (const [k, v] of Object.entries(data.claims)) {
          if (Array.isArray(v)) for (const vi of v) addRow(k, vi); else addRow(k, v);
        }
      }
    };

    function personaFromUi() {
      const kvs = [];
      for (const wrap of claimsGrid.children) {
        const key = wrap.children[0].value.trim();
        const val = wrap.children[1].value.trim();
        if (!key || !val) continue;
        kvs.push({ key, value: val });
      }
      return {
        name: u.value.trim(),
        email: e.value.trim(),
        roles: roles.value.split(',').map(s => s.trim()).filter(Boolean),
        permissions: perms.value.split(',').map(s => s.trim()).filter(Boolean),
        claims: kvs
      };
    }

    document.getElementById('f').addEventListener('submit', ev => {
      ev.preventDefault();
      const data = personaFromUi();
      if (persist) {
        localStorage.setItem('tp_u', data.name||'');
        localStorage.setItem('tp_e', data.email||'');
        localStorage.setItem('tp_roles', (data.roles||[]).join(','));
        localStorage.setItem('tp_perms', (data.permissions||[]).join(','));
        localStorage.setItem('tp_claims', JSON.stringify(data.claims||[]));
        // Save to recent logins
        saveRecentLogin(data);
      }
      document.cookie = `_tp_user=${encodeURIComponent(data.name||'')}|${encodeURIComponent(data.email||'')}; path=/`;
  const base = '/.testoauth/authorize';
      const p = new URLSearchParams(location.search);
  const params = new URLSearchParams();
      params.set('response_type', 'code');
      params.set('client_id', p.get('client_id')||'');
      params.set('redirect_uri', p.get('redirect_uri')||'');
  const st = p.get('state'); if (st) params.set('state', st);
  const sc = p.get('scope'); if (sc) params.set('scope', sc);
  const cc = p.get('code_challenge'); if (cc) params.set('code_challenge', cc);
  const ccm = p.get('code_challenge_method'); if (ccm) params.set('code_challenge_method', ccm);
      if (data.roles && data.roles.length) params.set('roles', data.roles.join(','));
      if (data.permissions && data.permissions.length) params.set('perms', data.permissions.join(','));
      for (const kv of data.claims||[]) params.append(`claim.${kv.key}`, kv.value);
      location.href = `${base}?${params.toString()}`;
    });

    // Wire up Clear All Recent Logins button
    document.getElementById('clearAllRecent').onclick = () => {
      if (confirm('Clear all recent logins?')) {
        clearAllRecentLogins();
      }
    };

    loadDefaults();
    renderRecentLogins();
  </script>
  <noscript>Enable JavaScript.</noscript>
</body>
</html>