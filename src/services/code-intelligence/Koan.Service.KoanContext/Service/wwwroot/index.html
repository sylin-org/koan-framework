<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Koan Context - Semantic Code Search</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { background: #2c3e50; color: white; padding: 20px 0; margin-bottom: 30px; }
        header h1 { font-size: 28px; font-weight: 600; }
        header p { opacity: 0.9; margin-top: 5px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #ddd; }
        .tab { padding: 12px 24px; background: none; border: none; cursor: pointer; font-size: 16px; color: #666; border-bottom: 3px solid transparent; transition: all 0.2s; }
        .tab.active { color: #3498db; border-bottom-color: #3498db; font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Projects Tab */
        .project-actions { display: flex; gap: 15px; margin-bottom: 20px; }
        .btn { padding: 12px 24px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: background 0.2s; }
        .btn:hover { background: #2980b9; }
        .btn-secondary { background: #95a5a6; }
        .btn-secondary:hover { background: #7f8c8d; }
        .btn-danger { background: #e74c3c; }
        .btn-danger:hover { background: #c0392b; }
        .projects-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .project-card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s; }
        .project-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .project-card h3 { font-size: 18px; margin-bottom: 10px; color: #2c3e50; }
        .project-card .path { font-family: 'Courier New', monospace; font-size: 12px; color: #7f8c8d; margin-bottom: 15px; word-break: break-all; }
        .project-card .meta { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .badge { padding: 4px 8px; background: #ecf0f1; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .badge.active { background: #2ecc71; color: white; }
        .badge.indexed { background: #3498db; color: white; }
        .badge.indexing { background: #f39c12; color: white; animation: pulse 2s infinite; }
        .badge.failed { background: #e74c3c; color: white; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .project-actions-btn { display: flex; gap: 10px; }
        .btn-small { padding: 8px 16px; font-size: 13px; }

        /* Search Tab */
        .search-box { background: white; border-radius: 8px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .search-box h2 { margin-bottom: 20px; color: #2c3e50; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        select, input[type="text"], input[type="range"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        input[type="range"] { padding: 0; }
        .slider-labels { display: flex; justify-content: space-between; font-size: 12px; color: #7f8c8d; margin-top: 5px; }
        .search-results { background: white; border-radius: 8px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .result-item { border-bottom: 1px solid #ecf0f1; padding: 20px 0; }
        .result-item:last-child { border-bottom: none; }
        .result-item h4 { color: #2c3e50; margin-bottom: 10px; font-size: 16px; }
        .result-text { margin: 10px 0; line-height: 1.6; color: #555; white-space: pre-wrap; font-size: 14px; background: #f8f9fa; padding: 15px; border-radius: 6px; max-height: 200px; overflow-y: auto; }
        .result-meta { display: flex; gap: 15px; flex-wrap: wrap; margin-top: 10px; }
        .result-meta-item { font-size: 12px; color: #7f8c8d; }
        .result-meta-item strong { color: #555; }
        .score { background: #3498db; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal.active { display: flex; align-items: center; justify-content: center; animation: fadeIn 0.2s; }
        .modal-content { background: white; border-radius: 8px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .modal-content h2 { margin-bottom: 20px; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }

        .loading { text-align: center; padding: 40px; color: #7f8c8d; }
        .error { background: #e74c3c; color: white; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
        .success { background: #2ecc71; color: white; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
        .warning { background: #f39c12; color: white; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
        .empty { text-align: center; padding: 60px; color: #95a5a6; }
        .btn-warning { background: #f39c12; }
        .btn-warning:hover { background: #e67e22; }
        .conflict-message { background: #fff3cd; border: 1px solid #ffc107; color: #856404; padding: 15px; border-radius: 6px; margin-top: 10px; }
        .conflict-message strong { display: block; margin-bottom: 5px; }

        /* Settings Tab */
        .settings-container { max-width: 900px; }
        .settings-section { background: white; border-radius: 8px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .settings-section h2 { color: #2c3e50; margin-bottom: 5px; font-size: 20px; }
        .settings-section .section-desc { color: #7f8c8d; font-size: 13px; margin-bottom: 20px; }
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .settings-grid-full { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .form-row { display: flex; flex-direction: column; }
        .form-row label { font-weight: 600; color: #555; margin-bottom: 8px; font-size: 14px; }
        .form-row input[type="number"], .form-row select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .form-row .help-text { font-size: 12px; color: #7f8c8d; margin-top: 4px; }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .3s; border-radius: 26px; }
        .toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .3s; border-radius: 50%; }
        .toggle-switch input:checked + .toggle-slider { background-color: #2ecc71; }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(24px); }
        .toggle-row { display: flex; align-items: center; gap: 12px; }
        .save-settings-btn { margin-top: 20px; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 25px; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 2000; animation: slideIn 0.3s; }
        .notification.success { background: #2ecc71; color: white; }
        .notification.error { background: #e74c3c; color: white; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Koan Context</h1>
            <p>Semantic code search powered by vector embeddings</p>
        </div>
    </header>

    <div class="container">
        <div class="tabs">
            <button class="tab active" data-tab="projects">Projects</button>
            <button class="tab" data-tab="search">Search</button>
            <button class="tab" data-tab="settings">Settings</button>
        </div>

        <!-- Projects Tab -->
        <div class="tab-content active" id="projects">
            <div class="project-actions">
                <button class="btn" onclick="showCreateProjectModal()">+ New Project</button>
                <button class="btn btn-secondary" onclick="loadProjects()">Refresh</button>
            </div>
            <div id="projects-list" class="projects-grid"></div>
        </div>

        <!-- Search Tab -->
        <div class="tab-content" id="search">
            <div class="search-box">
                <h2>Semantic Search</h2>
                <div class="form-group">
                    <label for="searchProject">Select Project</label>
                    <select id="searchProject">
                        <option value="">Loading projects...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="searchQuery">Search Query</label>
                    <input type="text" id="searchQuery" placeholder="Enter your search query...">
                </div>
                <div class="form-group">
                    <label for="alphaSlider">Search Mode (Alpha: <span id="alphaValue">0.7</span>)</label>
                    <input type="range" id="alphaSlider" min="0" max="1" step="0.1" value="0.7">
                    <div class="slider-labels">
                        <span>Keyword (BM25)</span>
                        <span>Hybrid</span>
                        <span>Semantic (Vector)</span>
                    </div>
                </div>
                <button class="btn" onclick="performSearch()">Search</button>
            </div>
            <div id="search-results"></div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-content" id="settings">
            <div class="settings-container">
                <div id="settings-notification"></div>

                <!-- Auto-Resume Settings -->
                <div class="settings-section">
                    <h2>Auto-Resume Settings</h2>
                    <p class="section-desc">Control how interrupted indexing jobs are resumed after service restarts</p>
                    <div class="settings-grid">
                        <div class="form-row">
                            <label>
                                <div class="toggle-row">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="autoResumeIndexing">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span>Auto-Resume Indexing</span>
                                </div>
                            </label>
                            <p class="help-text">Automatically resume interrupted indexing jobs on startup</p>
                        </div>
                        <div class="form-row">
                            <label for="autoResumeDelay">Resume Delay</label>
                            <select id="autoResumeDelay">
                                <option value="-1">Never</option>
                                <option value="0">Immediate</option>
                                <option value="10">10 seconds</option>
                                <option value="30">30 seconds</option>
                                <option value="60">1 minute</option>
                                <option value="300">5 minutes</option>
                            </select>
                            <p class="help-text">Delay before auto-resuming interrupted jobs</p>
                        </div>
                    </div>
                </div>

                <!-- Job Maintenance Settings -->
                <div class="settings-section">
                    <h2>Job Maintenance</h2>
                    <p class="section-desc">Manage job retention and cleanup policies</p>
                    <div class="settings-grid">
                        <div class="form-row">
                            <label for="maxJobsPerProject">Max Jobs Per Project</label>
                            <input type="number" id="maxJobsPerProject" min="10" max="500" step="10">
                            <p class="help-text">Maximum number of jobs to retain for audit history</p>
                        </div>
                        <div class="form-row">
                            <label for="jobRetentionDays">Job Retention (days)</label>
                            <input type="number" id="jobRetentionDays" min="1" max="90" step="1">
                            <p class="help-text">How many days to keep completed/failed jobs</p>
                        </div>
                        <div class="form-row">
                            <label>
                                <div class="toggle-row">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="enableAutomaticCleanup">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span>Enable Automatic Cleanup</span>
                                </div>
                            </label>
                            <p class="help-text">Automatically cleanup orphaned jobs on startup</p>
                        </div>
                    </div>
                </div>

                <!-- Indexing Performance Settings -->
                <div class="settings-section">
                    <h2>Indexing Performance</h2>
                    <p class="section-desc">Tune indexing speed and resource usage</p>
                    <div class="settings-grid">
                        <div class="form-row">
                            <label for="maxConcurrentIndexingJobs">Max Concurrent Jobs</label>
                            <input type="number" id="maxConcurrentIndexingJobs" min="1" max="10" step="1">
                            <p class="help-text">Number of projects that can be indexed concurrently</p>
                        </div>
                        <div class="form-row">
                            <label for="embeddingBatchSize">Embedding Batch Size</label>
                            <input type="number" id="embeddingBatchSize" min="10" max="200" step="10">
                            <p class="help-text">Chunks to process in a single embedding batch</p>
                        </div>
                        <div class="form-row">
                            <label for="defaultTokenBudget">Default Token Budget</label>
                            <input type="number" id="defaultTokenBudget" min="1000" max="50000" step="1000">
                            <p class="help-text">Default token budget for search queries</p>
                        </div>
                        <div class="form-row">
                            <label for="indexingChunkSize">Chunk Size (tokens)</label>
                            <input type="number" id="indexingChunkSize" min="256" max="4096" step="256">
                            <p class="help-text">Target chunk size in tokens for code splitting</p>
                        </div>
                        <div class="form-row">
                            <label for="maxFileSizeMB">Max File Size (MB)</label>
                            <input type="number" id="maxFileSizeMB" min="1" max="100" step="1">
                            <p class="help-text">Skip files larger than this size</p>
                        </div>
                        <div class="form-row">
                            <label for="maxDegreeOfParallelism">Max Parallelism</label>
                            <input type="number" id="maxDegreeOfParallelism" min="1" max="16" step="1">
                            <p class="help-text">Maximum degree of parallelism for file processing</p>
                        </div>
                        <div class="form-row">
                            <label>
                                <div class="toggle-row">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="enableParallelProcessing">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span>Enable Parallel Processing</span>
                                </div>
                            </label>
                            <p class="help-text">Process multiple files concurrently during indexing</p>
                        </div>
                    </div>
                </div>

                <!-- Storage & Cleanup Settings -->
                <div class="settings-section">
                    <h2>Storage & Cleanup</h2>
                    <p class="section-desc">Manage database size and maintenance</p>
                    <div class="settings-grid">
                        <div class="form-row">
                            <label>
                                <div class="toggle-row">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="enableAutomaticChunkCleanup">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span>Auto Chunk Cleanup</span>
                                </div>
                            </label>
                            <p class="help-text">Delete old chunks when reindexing a project</p>
                        </div>
                        <div class="form-row">
                            <label>
                                <div class="toggle-row">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="vacuumDatabaseOnStartup">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span>Vacuum DB on Startup</span>
                                </div>
                            </label>
                            <p class="help-text">Run SQLite VACUUM to reclaim space</p>
                        </div>
                        <div class="form-row">
                            <label for="maxDatabaseSizeGB">Max Database Size (GB)</label>
                            <input type="number" id="maxDatabaseSizeGB" min="10" max="500" step="10">
                            <p class="help-text">Alert threshold for database size</p>
                        </div>
                        <div class="form-row">
                            <label>
                                <div class="toggle-row">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="enableEmbeddingCompression">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span>Embedding Compression</span>
                                </div>
                            </label>
                            <p class="help-text">Compress old vector embeddings</p>
                        </div>
                        <div class="form-row">
                            <label for="embeddingCompressionDays">Compression Age (days)</label>
                            <input type="number" id="embeddingCompressionDays" min="7" max="365" step="7">
                            <p class="help-text">Days before compressing embeddings</p>
                        </div>
                    </div>
                </div>

                <!-- Logging & Diagnostics Settings -->
                <div class="settings-section">
                    <h2>Logging & Diagnostics</h2>
                    <p class="section-desc">Configure logging detail and performance tracking</p>
                    <div class="settings-grid">
                        <div class="form-row">
                            <label>
                                <div class="toggle-row">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="enableDetailedIndexingLogs">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span>Detailed Indexing Logs</span>
                                </div>
                            </label>
                            <p class="help-text">Enable verbose indexing progress logs</p>
                        </div>
                        <div class="form-row">
                            <label>
                                <div class="toggle-row">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="enablePerformanceMetrics">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span>Performance Metrics</span>
                                </div>
                            </label>
                            <p class="help-text">Track and report indexing performance metrics</p>
                        </div>
                        <div class="form-row">
                            <label>
                                <div class="toggle-row">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="enableQueryTracing">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span>Query Tracing</span>
                                </div>
                            </label>
                            <p class="help-text">Enable query performance tracing</p>
                        </div>
                        <div class="form-row">
                            <label for="logRetentionDays">Log Retention (days)</label>
                            <input type="number" id="logRetentionDays" min="7" max="365" step="7">
                            <p class="help-text">How many days to keep logs (0 = keep all)</p>
                        </div>
                        <div class="form-row">
                            <label for="slowQueryThresholdMs">Slow Query Threshold (ms)</label>
                            <input type="number" id="slowQueryThresholdMs" min="100" max="10000" step="100">
                            <p class="help-text">Log queries that exceed this duration</p>
                        </div>
                    </div>
                </div>

                <!-- Save Button -->
                <button class="btn save-settings-btn" onclick="saveSettings()">Save Configuration</button>
            </div>
        </div>
    </div>

    <!-- Create Project Modal -->
    <div class="modal" id="createProjectModal">
        <div class="modal-content">
            <h2>Create New Project</h2>
            <div class="form-group">
                <label for="projectName">Project Name</label>
                <input type="text" id="projectName" placeholder="My Project">
            </div>
            <div class="form-group">
                <label for="projectPath">Root Path</label>
                <input type="text" id="projectPath" placeholder="/path/to/project">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideCreateProjectModal()">Cancel</button>
                <button class="btn" onclick="createProject()">Create & Index</button>
            </div>
        </div>
    </div>

    <!-- Force Restart Modal -->
    <div class="modal" id="forceRestartModal">
        <div class="modal-content">
            <h2>⚠️ Force Restart Indexing</h2>
            <div class="warning" style="margin-bottom: 20px;">
                <strong>Warning:</strong> This project is currently being indexed.
            </div>
            <p>Forcing a restart will:</p>
            <ul style="margin: 15px 0; padding-left: 20px; line-height: 1.8;">
                <li>Cancel the current indexing job</li>
                <li>Start a new indexing job from scratch</li>
                <li>May result in incomplete data during the transition</li>
            </ul>
            <p><strong>Are you sure you want to force restart?</strong></p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideForceRestartModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmForceRestart()">Force Restart</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let projects = [];
        let currentForceRestartProjectId = null;

        // Status enum mapping (matches IndexingStatus enum)
        const IndexingStatus = {
            NotIndexed: 0,
            Indexing: 1,
            Ready: 2,
            Failed: 3,
            Updating: 4
        };

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        // Alpha slider
        document.getElementById('alphaSlider').addEventListener('input', (e) => {
            document.getElementById('alphaValue').textContent = e.target.value;
        });

        // Auto-refresh interval for indexing projects
        let autoRefreshInterval = null;

        // Load projects on page load
        window.addEventListener('load', () => {
            loadProjects();
            startAutoRefresh();
        });

        function startAutoRefresh() {
            // Refresh every 10 seconds if any project is indexing
            autoRefreshInterval = setInterval(() => {
                const hasIndexingProjects = projects.some(p =>
                    p.status === IndexingStatus.Indexing ||
                    p.status === IndexingStatus.Updating
                );

                if (hasIndexingProjects) {
                    loadProjects();
                }
            }, 10000);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        async function loadProjects() {
            try {
                // Fetch both projects and active jobs in parallel
                const [projectsResponse, jobsResponse] = await Promise.all([
                    fetch(`${API_BASE}/projects`),
                    fetch(`${API_BASE}/jobs/active`)
                ]);

                projects = await projectsResponse.json();
                const jobsData = await jobsResponse.json();

                // Create a map of active jobs by projectId
                const activeJobsByProject = {};
                if (jobsData.jobs) {
                    jobsData.jobs.forEach(job => {
                        activeJobsByProject[job.projectId] = job;
                    });
                }

                // Enrich projects with active job data
                projects = projects.map(p => {
                    const activeJob = activeJobsByProject[p.id];
                    if (activeJob) {
                        return {
                            ...p,
                            status: IndexingStatus.Indexing, // Override status if there's an active job
                            activeJob: activeJob
                        };
                    }
                    return p;
                });

                renderProjects(projects);
                updateSearchProjectDropdown();
            } catch (error) {
                console.error('Failed to load projects:', error);
                document.getElementById('projects-list').innerHTML = '<div class="error">Failed to load projects</div>';
            }
        }

        function getStatusBadge(project) {
            switch (project.status) {
                case IndexingStatus.Indexing:
                    return '<span class="badge indexing">Indexing...</span>';
                case IndexingStatus.Ready:
                    return '<span class="badge indexed">Ready</span>';
                case IndexingStatus.Failed:
                    return '<span class="badge failed">Failed</span>';
                case IndexingStatus.Updating:
                    return '<span class="badge indexing">Updating...</span>';
                case IndexingStatus.NotIndexed:
                default:
                    return '<span class="badge">Not Indexed</span>';
            }
        }

        function getActionButtons(project) {
            const isIndexing = project.status === IndexingStatus.Indexing || project.status === IndexingStatus.Updating;

            if (isIndexing) {
                return `
                    <button class="btn btn-small btn-warning" onclick="showForceRestartModal('${project.id}')">Force Restart</button>
                    <button class="btn btn-small btn-secondary" onclick="viewProject('${project.id}')">View</button>
                `;
            }

            return `
                <button class="btn btn-small" onclick="reindexProject('${project.id}', false)">Reindex</button>
                <button class="btn btn-small btn-secondary" onclick="viewProject('${project.id}')">View</button>
                <button class="btn btn-small btn-danger" onclick="deleteProject('${project.id}')">Delete</button>
            `;
        }

        function renderProjects(projects) {
            const list = document.getElementById('projects-list');
            if (projects.length === 0) {
                list.innerHTML = '<div class="empty"><h3>No projects yet</h3><p>Create your first project to get started!</p></div>';
                return;
            }
            list.innerHTML = projects.map(p => {
                const progressInfo = p.activeJob ? `
                    <div style="margin-top: 10px; font-size: 13px; color: #555;">
                        <div style="margin-bottom: 5px;">
                            <strong>Progress:</strong> ${p.activeJob.processedFiles || 0} / ${p.activeJob.totalFiles || 0} files (${Math.round(p.activeJob.progress || 0)}%)
                        </div>
                        ${p.activeJob.currentOperation ? `<div style="margin-bottom: 5px;"><strong>Operation:</strong> ${p.activeJob.currentOperation}</div>` : ''}
                        ${p.activeJob.estimatedCompletion ? `<div><strong>ETA:</strong> ${new Date(p.activeJob.estimatedCompletion).toLocaleTimeString()}</div>` : ''}
                    </div>
                ` : '';

                return `
                    <div class="project-card">
                        <h3>${p.name}</h3>
                        <div class="path">${p.rootPath}</div>
                        <div class="meta">
                            <span class="badge ${p.isActive ? 'active' : ''}">
                                ${p.isActive ? 'Active' : 'Inactive'}
                            </span>
                            ${getStatusBadge(p)}
                            ${p.documentCount > 0 ? `<span class="badge">${p.documentCount} docs</span>` : ''}
                        </div>
                        ${progressInfo}
                        <div class="project-actions-btn">
                            ${getActionButtons(p)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateSearchProjectDropdown() {
            const select = document.getElementById('searchProject');
            if (projects.length === 0) {
                select.innerHTML = '<option value="">No projects available</option>';
                return;
            }
            select.innerHTML = projects.map(p =>
                `<option value="${p.id}">${p.name} (${p.documentCount || 0} docs)</option>`
            ).join('');
        }

        function showCreateProjectModal() {
            document.getElementById('createProjectModal').classList.add('active');
        }

        function hideCreateProjectModal() {
            document.getElementById('createProjectModal').classList.remove('active');
        }

        function showForceRestartModal(projectId) {
            currentForceRestartProjectId = projectId;
            document.getElementById('forceRestartModal').classList.add('active');
        }

        function hideForceRestartModal() {
            currentForceRestartProjectId = null;
            document.getElementById('forceRestartModal').classList.remove('active');
        }

        async function confirmForceRestart() {
            if (!currentForceRestartProjectId) return;

            hideForceRestartModal();
            await reindexProject(currentForceRestartProjectId, true);
        }

        async function createProject() {
            const name = document.getElementById('projectName').value;
            const path = document.getElementById('projectPath').value;

            if (!name || !path) {
                alert('Please fill in all fields');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/projects/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, rootPath: path, projectType: 0 })
                });

                if (!response.ok) throw new Error('Failed to create project');

                const project = await response.json();
                hideCreateProjectModal();
                loadProjects();

                // Auto-trigger indexing
                indexProject(project.id);
            } catch (error) {
                alert('Failed to create project: ' + error.message);
            }
        }

        async function reindexProject(id, force = false) {
            if (!force && !confirm('Start reindexing? This may take several minutes.')) return;

            try {
                const url = `${API_BASE}/projects/${id}/reindex${force ? '?force=true' : ''}`;
                const response = await fetch(url, { method: 'POST' });

                if (response.status === 409) {
                    // Conflict - already indexing
                    const data = await response.json();
                    if (confirm(`${data.message}\n\nDo you want to force restart the indexing?`)) {
                        await reindexProject(id, true);
                    }
                    return;
                }

                if (response.status === 202) {
                    // Accepted - indexing started
                    const data = await response.json();
                    alert(force
                        ? `Force restart successful! Indexing has been restarted.\n\nCheck the project status for progress.`
                        : `Indexing started!\n\nCheck the project status for progress.`
                    );
                    loadProjects();

                    // Auto-refresh after 5 seconds to show progress
                    setTimeout(loadProjects, 5000);
                    return;
                }

                throw new Error(`Unexpected response: ${response.status}`);
            } catch (error) {
                alert('Reindexing failed: ' + error.message);
            }
        }

        async function indexProject(id) {
            // Alias for backwards compatibility
            await reindexProject(id, false);
        }

        async function deleteProject(id) {
            if (!confirm('Delete this project? This cannot be undone.')) return;

            try {
                const response = await fetch(`${API_BASE}/projects/${id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Failed to delete');
                loadProjects();
            } catch (error) {
                alert('Failed to delete project: ' + error.message);
            }
        }

        function viewProject(id) {
            const project = projects.find(p => p.id === id);
            if (project) {
                const statusText = ['Not Indexed', 'Indexing', 'Ready', 'Failed', 'Updating'][project.status] || 'Unknown';
                const details = [
                    `Project: ${project.name}`,
                    `Path: ${project.rootPath}`,
                    `Status: ${statusText}`,
                    `Documents: ${project.documentCount || 0}`,
                    `Indexed Bytes: ${(project.indexedBytes || 0).toLocaleString()}`,
                    project.indexingStartedAt ? `Started: ${new Date(project.indexingStartedAt).toLocaleString()}` : null,
                    project.indexingCompletedAt ? `Completed: ${new Date(project.indexingCompletedAt).toLocaleString()}` : null,
                    project.indexingError ? `Error: ${project.indexingError}` : null
                ].filter(Boolean).join('\\n');

                alert(details);
            }
        }

        let currentSearchParams = null;
        let currentContinuationToken = null;

        async function performSearch(continuationToken = null) {
            const projectId = document.getElementById('searchProject').value;
            const query = document.getElementById('searchQuery').value;
            const alpha = parseFloat(document.getElementById('alphaSlider').value);

            if (!projectId || !query) {
                alert('Please select a project and enter a search query');
                return;
            }

            // Store current search params for pagination
            if (!continuationToken) {
                currentSearchParams = { projectId, query, alpha };
                currentContinuationToken = null;
            }

            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = '<div class="loading">Searching...</div>';

            try {
                const body = {
                    projectId,
                    query,
                    alpha,
                    topK: 10,
                    tokenBudget: 5000
                };

                if (continuationToken) {
                    body.continuationToken = continuationToken;
                }

                const response = await fetch(`${API_BASE}/search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Search failed');
                }

                const result = await response.json();
                renderSearchResults(result, continuationToken !== null);
            } catch (error) {
                resultsDiv.innerHTML = '<div class="error">Search failed: ' + error.message + '</div>';
            }
        }

        async function loadNextPage() {
            if (currentContinuationToken && currentSearchParams) {
                await performSearch(currentContinuationToken);
            }
        }

        function parseDuration(durationString) {
            // Parse TimeSpan format: "00:00:00.0092450"
            const parts = durationString.split(':');
            const secondsParts = parts[2].split('.');
            const hours = parseInt(parts[0]);
            const minutes = parseInt(parts[1]);
            const seconds = parseInt(secondsParts[0]);
            const milliseconds = parseInt(secondsParts[1].substring(0, 3));

            return (hours * 3600000) + (minutes * 60000) + (seconds * 1000) + milliseconds;
        }

        function renderSearchResults(result, isAppend = false) {
            const resultsDiv = document.getElementById('search-results');

            if (!result.chunks || result.chunks.length === 0) {
                resultsDiv.innerHTML = '<div class="empty"><h3>No results found</h3><p>Try adjusting your query or search mode.</p></div>';
                currentContinuationToken = null;
                return;
            }

            // Extract continuation token from top-level field
            currentContinuationToken = result.continuationToken || null;

            const durationMs = parseDuration(result.metadata.duration);
            const sourceFiles = result.sources?.files?.length || 0;

            const resultsHtml = `
                <div class="search-results">
                    ${!isAppend ? `
                        <h2>Search Results</h2>
                        <div class="result-meta" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                            <span class="result-meta-item"><strong>Duration:</strong> ${durationMs}ms</span>
                            <span class="result-meta-item"><strong>Tokens:</strong> ${result.metadata.tokensReturned} / ${result.metadata.tokensRequested}</span>
                            <span class="result-meta-item"><strong>Sources:</strong> ${sourceFiles} files</span>
                            <span class="result-meta-item"><strong>Model:</strong> ${result.metadata.model}</span>
                            ${result.metadata.page ? `<span class="result-meta-item"><strong>Page:</strong> ${result.metadata.page}</span>` : ''}
                        </div>
                    ` : ''}
                    <div id="results-list">
                        ${result.chunks.map((chunk, i) => {
                            // Use sourceIndex to look up the source file
                            const source = result.sources?.files?.[chunk.provenance?.sourceIndex];
                            return `
                                <div class="result-item">
                                    <h4>${isAppend ? '' : `${i + 1}. `}${source?.title || source?.filePath || 'Unknown'}</h4>
                                    <div class="result-text">${escapeHtml(chunk.text)}</div>
                                    <div class="result-meta">
                                        <span class="result-meta-item"><strong>File:</strong> ${source?.filePath || 'N/A'}</span>
                                        ${source?.commitSha ? `<span class="result-meta-item"><strong>Commit:</strong> ${source.commitSha.substring(0, 7)}</span>` : ''}
                                        ${chunk.provenance?.language ? `<span class="result-meta-item"><strong>Lang:</strong> ${chunk.provenance.language}</span>` : ''}
                                        ${chunk.provenance?.startLine ? `<span class="result-meta-item"><strong>Lines:</strong> ${chunk.provenance.startLine}-${chunk.provenance.endLine}</span>` : ''}
                                        <span class="score">${(chunk.score * 100).toFixed(1)}% match</span>
                                        ${chunk.reasoning?.strategy ? `<span class="badge">${chunk.reasoning.strategy}</span>` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    ${currentContinuationToken ? `
                        <div style="text-align: center; margin-top: 30px;">
                            <button class="btn" onclick="loadNextPage()">Load More Results</button>
                            <p style="margin-top: 10px; color: #7f8c8d; font-size: 13px;">More results available</p>
                        </div>
                    ` : `
                        <div style="text-align: center; margin-top: 30px; color: #7f8c8d; font-size: 13px;">
                            <p>End of results</p>
                        </div>
                    `}
                </div>
            `;

            if (isAppend) {
                // Append new results to existing list
                const resultsList = document.getElementById('results-list');
                if (resultsList) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = resultsHtml;
                    const newItems = tempDiv.querySelector('#results-list').innerHTML;
                    resultsList.insertAdjacentHTML('beforeend', newItems);

                    // Update the load more button
                    const loadMoreContainer = resultsDiv.querySelector('.search-results > div:last-child');
                    if (loadMoreContainer && loadMoreContainer.querySelector('button, p')) {
                        loadMoreContainer.innerHTML = currentContinuationToken ? `
                            <button class="btn" onclick="loadNextPage()">Load More Results</button>
                            <p style="margin-top: 10px; color: #7f8c8d; font-size: 13px;">More results available</p>
                        ` : `
                            <p>End of results</p>
                        `;
                    }
                }
            } else {
                resultsDiv.innerHTML = resultsHtml;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Settings Management
        let settingsLoaded = false;

        // Load settings when Settings tab is clicked
        document.querySelectorAll('.tab').forEach(tab => {
            if (tab.dataset.tab === 'settings') {
                tab.addEventListener('click', () => {
                    if (!settingsLoaded) {
                        loadSettings();
                        settingsLoaded = true;
                    }
                });
            }
        });

        async function loadSettings() {
            try {
                const response = await fetch(`${API_BASE}/configuration`);
                if (!response.ok) throw new Error('Failed to load settings');

                const settings = await response.json();
                populateSettingsForm(settings);
            } catch (error) {
                console.error('Failed to load settings:', error);
                showNotification('Failed to load settings: ' + error.message, 'error');
            }
        }

        function populateSettingsForm(settings) {
            // Auto-Resume Settings
            document.getElementById('autoResumeIndexing').checked = settings.autoResumeIndexing ?? true;
            document.getElementById('autoResumeDelay').value = settings.autoResumeDelay ?? 0;

            // Job Maintenance Settings
            document.getElementById('maxJobsPerProject').value = settings.jobMaintenance?.maxJobsPerProject ?? 50;
            document.getElementById('jobRetentionDays').value = settings.jobMaintenance?.jobRetentionDays ?? 7;
            document.getElementById('enableAutomaticCleanup').checked = settings.jobMaintenance?.enableAutomaticCleanup ?? true;

            // Indexing Performance Settings
            document.getElementById('maxConcurrentIndexingJobs').value = settings.indexingPerformance?.maxConcurrentIndexingJobs ?? 2;
            document.getElementById('embeddingBatchSize').value = settings.indexingPerformance?.embeddingBatchSize ?? 50;
            document.getElementById('defaultTokenBudget').value = settings.indexingPerformance?.defaultTokenBudget ?? 5000;
            document.getElementById('indexingChunkSize').value = settings.indexingPerformance?.indexingChunkSize ?? 1024;
            document.getElementById('maxFileSizeMB').value = settings.indexingPerformance?.maxFileSizeMB ?? 10;
            document.getElementById('maxDegreeOfParallelism').value = settings.indexingPerformance?.maxDegreeOfParallelism ?? 4;
            document.getElementById('enableParallelProcessing').checked = settings.indexingPerformance?.enableParallelProcessing ?? true;

            // Storage & Cleanup Settings
            document.getElementById('enableAutomaticChunkCleanup').checked = settings.storageCleanup?.enableAutomaticChunkCleanup ?? true;
            document.getElementById('vacuumDatabaseOnStartup').checked = settings.storageCleanup?.vacuumDatabaseOnStartup ?? false;
            document.getElementById('maxDatabaseSizeGB').value = settings.storageCleanup?.maxDatabaseSizeGB ?? 50;
            document.getElementById('enableEmbeddingCompression').checked = settings.storageCleanup?.enableEmbeddingCompression ?? false;
            document.getElementById('embeddingCompressionDays').value = settings.storageCleanup?.embeddingCompressionDays ?? 30;

            // Logging & Diagnostics Settings
            document.getElementById('enableDetailedIndexingLogs').checked = settings.loggingDiagnostics?.enableDetailedIndexingLogs ?? false;
            document.getElementById('enablePerformanceMetrics').checked = settings.loggingDiagnostics?.enablePerformanceMetrics ?? true;
            document.getElementById('enableQueryTracing').checked = settings.loggingDiagnostics?.enableQueryTracing ?? false;
            document.getElementById('logRetentionDays').value = settings.loggingDiagnostics?.logRetentionDays ?? 30;
            document.getElementById('slowQueryThresholdMs').value = settings.loggingDiagnostics?.slowQueryThresholdMs ?? 1000;
        }

        async function saveSettings() {
            try {
                const settings = {
                    autoResumeIndexing: document.getElementById('autoResumeIndexing').checked,
                    autoResumeDelay: parseInt(document.getElementById('autoResumeDelay').value),
                    jobMaintenance: {
                        maxJobsPerProject: parseInt(document.getElementById('maxJobsPerProject').value),
                        jobRetentionDays: parseInt(document.getElementById('jobRetentionDays').value),
                        enableAutomaticCleanup: document.getElementById('enableAutomaticCleanup').checked
                    },
                    indexingPerformance: {
                        maxConcurrentIndexingJobs: parseInt(document.getElementById('maxConcurrentIndexingJobs').value),
                        embeddingBatchSize: parseInt(document.getElementById('embeddingBatchSize').value),
                        defaultTokenBudget: parseInt(document.getElementById('defaultTokenBudget').value),
                        indexingChunkSize: parseInt(document.getElementById('indexingChunkSize').value),
                        maxFileSizeMB: parseInt(document.getElementById('maxFileSizeMB').value),
                        enableParallelProcessing: document.getElementById('enableParallelProcessing').checked,
                        maxDegreeOfParallelism: parseInt(document.getElementById('maxDegreeOfParallelism').value)
                    },
                    storageCleanup: {
                        enableAutomaticChunkCleanup: document.getElementById('enableAutomaticChunkCleanup').checked,
                        vacuumDatabaseOnStartup: document.getElementById('vacuumDatabaseOnStartup').checked,
                        maxDatabaseSizeGB: parseInt(document.getElementById('maxDatabaseSizeGB').value),
                        enableEmbeddingCompression: document.getElementById('enableEmbeddingCompression').checked,
                        embeddingCompressionDays: parseInt(document.getElementById('embeddingCompressionDays').value)
                    },
                    loggingDiagnostics: {
                        enableDetailedIndexingLogs: document.getElementById('enableDetailedIndexingLogs').checked,
                        logRetentionDays: parseInt(document.getElementById('logRetentionDays').value),
                        enablePerformanceMetrics: document.getElementById('enablePerformanceMetrics').checked,
                        enableQueryTracing: document.getElementById('enableQueryTracing').checked,
                        slowQueryThresholdMs: parseInt(document.getElementById('slowQueryThresholdMs').value)
                    },
                    projectResolution: {
                        followSymbolicLinks: true,
                        matchAncestorProjects: true,
                        maxAncestorDepth: 2,
                        autoCreateProjectOnQuery: true,
                        autoIndexInBackground: true,
                        autoIndexRequireGitRepository: false,
                        autoIndexMaxSizeGB: 10,
                        topKMode: "per-project"
                    },
                    fileMonitoring: {
                        enabled: true,
                        debounceMilliseconds: 2000,
                        batchWindowMilliseconds: 5000,
                        maxConcurrentReindexOperations: 3,
                        maxConcurrentFileWatchers: 10,
                        restartOnFailure: true,
                        restartDelayMilliseconds: 5000
                    }
                };

                const response = await fetch(`${API_BASE}/configuration`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to save settings');
                }

                const result = await response.json();

                if (result.requiresRestart) {
                    showNotification('Settings saved successfully! Please restart the service for changes to take effect.', 'success');
                } else {
                    showNotification('Settings saved successfully!', 'success');
                }
            } catch (error) {
                console.error('Failed to save settings:', error);
                showNotification('Failed to save settings: ' + error.message, 'error');
            }
        }

        function showNotification(message, type = 'success') {
            // Remove any existing notifications
            const existing = document.querySelector('.notification');
            if (existing) {
                existing.remove();
            }

            // Create new notification
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
    </script>
</body>
</html>
