# Analysis: Koan Admin Surfaces

## Current Implementation Overview

- **Koan.Admin** now provides the shared configuration surface for admin experiences. `KoanAdminOptions` captures enablement flags, prefix policy, manifest exposure, destructive-operation gating, LaunchKit availability, authorization settings, logging controls, and generation defaults with environment-aware validation that blocks risky production settings.【F:src/Koan.Admin/Options/KoanAdminOptions.cs†L1-L32】【F:src/Koan.Admin/Options/KoanAdminOptionsValidator.cs†L1-L59】
- A runtime-aware route map is generated by `KoanAdminRouteProvider`, exposing root, API, health, manifest, and LaunchKit paths derived from the configured prefix. The provider reacts to option updates and feeds downstream consumers through `KoanAdminFeatureManager` snapshots.【F:src/Koan.Admin/Services/KoanAdminRouteProvider.cs†L1-L29】【F:src/Koan.Admin/Services/KoanAdminFeatureManager.cs†L1-L37】
- `KoanAdminManifestService` builds the diagnostics manifest by reusing module registrars to collect boot metadata and projecting health information from the central aggregator. Cached snapshots reduce redundant assembly scans while logging protects against registrar activation failures. The shared `Contracts` layer standardizes the manifest, module, health, and LaunchKit DTOs for both surfaces.【F:src/Koan.Admin/Services/KoanAdminManifestService.cs†L1-L148】【F:src/Koan.Admin/Contracts/KoanAdminManifest.cs†L1-L33】【F:src/Koan.Admin/Contracts/KoanAdminLaunchKitContracts.cs†L1-L33】
- `KoanAdminLaunchKitService` generates LaunchKit bundles (appsettings scaffolds, Compose profiles, Aspire manifests, metadata, and OpenAPI guidance) using live manifest data and configurable profiles, returning compressed archives through the shared contracts.【F:src/Koan.Admin/Services/KoanAdminLaunchKitService.cs†L1-L243】
- `KoanAdminAutoRegistrar` wires the core services automatically and contributes boot report details, including warnings for dot-prefixed routes or production enablement without explicit opt-in.【F:src/Koan.Admin/Initialization/KoanAdminAutoRegistrar.cs†L1-L38】

## Web Surface Status

- **Koan.Web.Admin** delivers an ASP.NET Core dashboard surface. The service collection extension ensures controller discovery, prefix rewriting via `KoanAdminRouteConvention`, and registers the shared core services.【F:src/Koan.Web.Admin/Extensions/ServiceCollectionExtensions.cs†L1-L19】【F:src/Koan.Web.Admin/Infrastructure/KoanAdminRouteConvention.cs†L1-L44】
- Requests are gated by `KoanAdminAuthorizationFilter`, which enforces feature enablement, authorization policy overrides, and optional network allow lists before controller logic executes.【F:src/Koan.Web.Admin/Infrastructure/KoanAdminAuthorizationFilter.cs†L1-L96】
- `KoanAdminStatusController` exposes `status`, `manifest`, and `health` endpoints under the configurable prefix, emitting environment snapshots, feature state, module manifests, and health diagnostics. The controller respects manifest gating and relies on the shared manifest service for data fidelity.【F:src/Koan.Web.Admin/Controllers/KoanAdminStatusController.cs†L1-L47】
- `KoanAdminLaunchKitController` and the embedded UI controller serve LaunchKit metadata, downloadable archives, and a bundled single-page dashboard compiled from embedded assets under the admin prefix.【F:src/Koan.Web.Admin/Controllers/KoanAdminLaunchKitController.cs†L1-L60】【F:src/Koan.Web.Admin/Controllers/KoanAdminUiController.cs†L1-L34】【F:src/Koan.Web.Admin/wwwroot/index.html†L1-L33】
- `Koan.Web.Admin` participates in auto-registration so hosts that reference the assembly get the surface without manual wiring.【F:src/Koan.Web.Admin/Initialization/KoanAutoRegistrar.cs†L1-L22】

## Host Integration & Samples

- The `S1.Web` sample now references both admin projects so development hosts automatically light up the admin surface. No additional bootstrap code is required because auto-registrars are discovered by `AddKoan`.【F:samples/S1.Web/S1.Web.csproj†L9-L15】
- `Koan.sln` includes the new projects, keeping solution tooling aligned with the framework module graph.【F:Koan.sln†L47-L54】【F:Koan.sln†L523-L546】

## Alignment with Proposal & Remaining Gaps

| Proposal Objective | Current Coverage | Notes |
| --- | --- | --- |
| Shared options & prefix validation | ✅ Implemented via `KoanAdminOptions`, generation defaults, and validator; dot-prefixed paths gated outside Development unless explicitly allowed. | LaunchKit defaults are configurable per environment. |
| Capability diagnostics & manifest | ✅ Manifest service reuses module registrars, caches results, and surfaces health aggregator data. | Console UI still outstanding. |
| LaunchKit bundle generation | ✅ LaunchKit metadata, archive generation, and contract layer implemented with profile support and OpenAPI scaffolding. | Future iterations can add additional bundle types and automation hooks. |
| Web dashboard surface under configurable namespace | ✅ Route convention rewrites `[koan-admin-root]`/`[koan-admin-api]` placeholders, controllers honor manifest gating, and embedded SPA assets ship with the package. | UI currently focused on overview/health/LaunchKit; advanced panels remain backlog. |
| Policy & network guardrails | ✅ Authorization filter enforces configured policy and CIDR/IP allow lists before controller execution. | Fine-grained role UX still to follow. |
| Console takeover | ❌ Not yet implemented. | Follow-up work must introduce `Koan.Console.Admin`. |

## Recommendations

1. **Console Module** – Implement `Koan.Console.Admin` to meet parity with LaunchKit CLI expectations and reuse the shared manifest services for diagnostics.
2. **Integration Tests** – Introduce end-to-end tests that verify prefix overrides, policy enforcement, LaunchKit archive content, and manifest availability toggles.
3. **Documentation** – Produce operational guidance covering default security posture, recommended production overrides, and sample workflows.
