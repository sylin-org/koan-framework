# Analysis: Koan Admin Surfaces

## Current Implementation Overview

- **Koan.Admin** now provides the shared configuration surface for admin experiences. `KoanAdminOptions` captures enablement flags, prefix policy, manifest exposure, destructive-operation gating, authorization settings, and logging controls with environment-aware defaults and validation rules that block risky production settings.【F:src/Koan.Admin/Options/KoanAdminOptions.cs†L1-L26】【F:src/Koan.Admin/Options/KoanAdminOptionsValidator.cs†L1-L34】
- A runtime-aware route map is generated by `KoanAdminRouteProvider`, exposing root, API, health, manifest, and LaunchKit paths derived from the configured prefix. The provider reacts to option updates and feeds downstream consumers through `KoanAdminFeatureManager` snapshots.【F:src/Koan.Admin/Services/KoanAdminRouteProvider.cs†L1-L29】【F:src/Koan.Admin/Services/KoanAdminFeatureManager.cs†L1-L37】
- `KoanAdminManifestService` builds the diagnostics manifest by reusing module registrars to collect boot metadata and projecting health information from the central aggregator. The shared `Contracts` layer standardizes the manifest, module, and health DTOs for both surfaces.【F:src/Koan.Admin/Services/KoanAdminManifestService.cs†L1-L86】【F:src/Koan.Admin/Contracts/KoanAdminManifest.cs†L1-L28】
- `KoanAdminAutoRegistrar` wires the core services automatically and contributes boot report details, including warnings for dot-prefixed routes or production enablement without explicit opt-in.【F:src/Koan.Admin/Initialization/KoanAdminAutoRegistrar.cs†L1-L38】

## Web Surface Status

- **Koan.Web.Admin** delivers an ASP.NET Core dashboard surface. The service collection extension ensures controller discovery, prefix rewriting via `KoanAdminRouteConvention`, and registers the shared core services.【F:src/Koan.Web.Admin/Extensions/ServiceCollectionExtensions.cs†L1-L19】【F:src/Koan.Web.Admin/Infrastructure/KoanAdminRouteConvention.cs†L1-L44】
- Requests are gated by `KoanAdminAuthorizationFilter`, which enforces feature enablement, authorization policy overrides, and optional network allow lists before controller logic executes.【F:src/Koan.Web.Admin/Infrastructure/KoanAdminAuthorizationFilter.cs†L1-L96】
- `KoanAdminStatusController` exposes `status`, `manifest`, and `health` endpoints under the configurable prefix, emitting environment snapshots, feature state, module manifests, and health diagnostics. The controller respects manifest gating and relies on the shared manifest service for data fidelity.【F:src/Koan.Web.Admin/Controllers/KoanAdminStatusController.cs†L1-L47】
- `Koan.Web.Admin` participates in auto-registration so hosts that reference the assembly get the surface without manual wiring.【F:src/Koan.Web.Admin/Initialization/KoanAutoRegistrar.cs†L1-L22】

## Host Integration & Samples

- The `S1.Web` sample now references both admin projects so development hosts automatically light up the admin surface. No additional bootstrap code is required because auto-registrars are discovered by `AddKoan`.【F:samples/S1.Web/S1.Web.csproj†L9-L15】
- `Koan.sln` includes the new projects, keeping solution tooling aligned with the framework module graph.【F:Koan.sln†L47-L54】【F:Koan.sln†L523-L546】

## Alignment with Proposal & Remaining Gaps

| Proposal Objective | Current Coverage | Notes |
| --- | --- | --- |
| Shared options & prefix validation | ✅ Implemented via `KoanAdminOptions` and validator; dot-prefixed paths gated outside Development unless explicitly allowed. | LaunchKit-specific toggles can be layered later; destructive ops are guarded. |
| Capability diagnostics & manifest | ✅ Manifest service reuses module registrars and health aggregator to emit consistent data. | Export endpoints exist but console UI still outstanding. |
| Web dashboard surface under configurable namespace | ✅ Route convention rewrites `[koan-admin-root]`/`[koan-admin-api]` placeholders to configured prefix, and controllers honor manifest gating. | Front-end UI assets are not yet included; APIs supply JSON payloads. |
| Policy & network guardrails | ✅ Authorization filter enforces configured policy and CIDR/IP allow lists before controller execution. | Fine-grained role UX still to follow. |
| Console takeover | ❌ Not yet implemented. | Follow-up work must introduce `Koan.Console.Admin`. |

## Recommendations

1. **Console Module** – Implement `Koan.Console.Admin` to meet parity with LaunchKit CLI expectations and reuse the shared manifest services for diagnostics.
2. **Static UI Bundle** – Add a lightweight SPA or Razor Pages surface inside `Koan.Web.Admin`’s `wwwroot` to visualize data returned by the APIs.
3. **LaunchKit Exporter** – Extend `KoanAdminManifestService` with bundle generation hooks to align with the LaunchKit export requirement.
4. **Integration Tests** – Introduce end-to-end tests that verify prefix overrides, policy enforcement, and manifest availability toggles.
5. **Documentation** – Produce operational guidance covering default security posture, recommended production overrides, and sample workflows.
