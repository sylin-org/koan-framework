# S13.DocMind Refactoring Plan (Proposal Delta)

## Completion Snapshot
- **Estimated completion:** ~65% of the proposal scope. The stage-aware `DocumentProcessingWorker` and durable job ledger now own document orchestration, and discovery requests reuse the cached `DocumentDiscoveryProjection`, aligning with the blueprint's worker and analytics goals.【F:samples/S13.DocMind/Infrastructure/DocumentProcessingWorker.cs†L1-L648】【F:samples/S13.DocMind/Models/DocumentProcessingJob.cs†L1-L190】【F:samples/S13.DocMind/Services/DocumentInsightsService.cs†L27-L77】【F:docs/chunks/S13-DocMind/03_ai_processing.md†L5-L39】
- **Outstanding delta:** Async discovery refresh orchestration, a first-class embeddings stage with telemetry, semantic profile bootstrap + adapter health signals, and the documented replay/config endpoints, health checks, and DocMind-focused automated tests remain incomplete.【F:samples/S13.DocMind/Infrastructure/DocumentProcessingWorker.cs†L207-L325】【F:samples/S13.DocMind/Infrastructure/DocumentProcessingWorker.cs†L637-L648】【F:samples/S13.DocMind/Infrastructure/DocumentVectorBootstrapper.cs†L20-L37】【F:samples/S13.DocMind/Controllers/ProcessingController.cs†L21-L75】【F:samples/S13.DocMind/Infrastructure/DocMindRegistrar.cs†L30-L74】【F:docs/chunks/S13-DocMind/04_api_ui_design.md†L6-L101】【F:docs/chunks/S13-DocMind/05_infrastructure.md†L90-L112】【F:docs/chunks/S13-DocMind/07_testing_ops.md†L1-L67】

## Remaining Delta

### 1. Discovery Refresh Orchestration
- **Inline rebuilds throttle completions.** The worker invokes `DocumentDiscoveryProjectionBuilder.RefreshAsync` after every aggregate stage, contradicting the proposal's goal of a lightweight worker and risking contention under load.【F:samples/S13.DocMind/Infrastructure/DocumentProcessingWorker.cs†L618-L648】【F:docs/chunks/S13-DocMind/03_ai_processing.md†L5-L39】 Move projection rebuilds to a scheduled job or throttled signal so completions only enqueue refresh requests.
- **Incremental accuracy is unproven.** Change detection skips redundant saves, but no load or regression tests exercise the incremental path described in the testing blueprint, leaving analytics fidelity unverified.【F:samples/S13.DocMind/Services/DocumentDiscoveryProjectionBuilder.cs†L20-L157】【F:docs/chunks/S13-DocMind/07_testing_ops.md†L1-L67】

### 2. Embedding Stage & Observability
- **Embeddings run inside extraction.** Chunk vectors are generated within `ExecuteExtractionAsync` and never advance through the `GenerateEmbedding` stage enumerated in the data blueprint, preventing retries and telemetry from isolating vector failures.【F:samples/S13.DocMind/Infrastructure/DocumentProcessingWorker.cs†L207-L325】【F:docs/chunks/S13-DocMind/02_entity_models.md†L163-L175】 Promote embeddings to a discrete stage that records processing events and snapshots before downstream work begins.
- **Vector costs lack metrics.** The blueprint's observability goals call for per-stage token and latency tracking, yet embedding operations currently emit no dedicated metrics or health signals.【F:samples/S13.DocMind/Infrastructure/DocumentProcessingWorker.cs†L207-L325】【F:docs/chunks/S13-DocMind/03_ai_processing.md†L55-L75】 Capture timing, token usage, and adapter status for embedding and suggestion calls.

### 3. Vector Bootstrap & Health Signals
- **Semantic profile vectors aren't validated.** `DocumentVectorBootstrapper` only ensures the chunk embedding index, leaving `SemanticTypeEmbedding` readiness unchecked despite the proposal's expectation of vector-backed template suggestions.【F:samples/S13.DocMind/Infrastructure/DocumentVectorBootstrapper.cs†L20-L37】【F:docs/chunks/S13-DocMind/02_entity_models.md†L140-L175】 Extend bootstrapping to audit, backfill, and gate semantic profile embeddings.
- **Adapter degradation stays silent.** Template suggestions fall back to cosine search when vectors fail, but no registrar or diagnostics surface indicates the degraded mode, undermining the infrastructure plan's health check guidance.【F:samples/S13.DocMind/Services/TemplateSuggestionService.cs†L126-L160】【F:samples/S13.DocMind/Infrastructure/DocMindRegistrar.cs†L30-L74】【F:docs/chunks/S13-DocMind/05_infrastructure.md†L90-L112】 Publish readiness and latency metrics through the registrar and processing events.

### 4. Replay & Operational Quality
- **Admin surface is incomplete.** The `ProcessingController` still lacks the `POST /api/processing/replay` and `GET /api/processing/config` endpoints promised in the API plan, preventing stage-targeted resumes and configuration introspection.【F:samples/S13.DocMind/Controllers/ProcessingController.cs†L21-L75】【F:docs/chunks/S13-DocMind/04_api_ui_design.md†L6-L101】 Implement the missing endpoints plus CLI/MCP bindings.
- **Health checks and telemetry wiring are absent.** `DocMindRegistrar` reports configuration but does not register the storage, embedding, or model health probes and OpenTelemetry instrumentation detailed in the infrastructure plan.【F:samples/S13.DocMind/Infrastructure/DocMindRegistrar.cs†L30-L74】【F:docs/chunks/S13-DocMind/05_infrastructure.md†L90-L112】 Wire health checks, readiness gates, and boot report sections accordingly.
- **Proposal-mandated tests are missing.** No DocMind-specific unit, integration, or CI automation exists, despite the testing plan's explicit expectations for fake-provider pipelines and regression coverage.【F:docs/chunks/S13-DocMind/07_testing_ops.md†L1-L67】 Create the outlined test projects and integrate them with CI.

## Delivery Order
1. **Discovery refresh hardening.** Decouple projection rebuilds from the worker and validate incremental accuracy under load before layering additional features.
2. **Embedding stage & vector health.** Introduce the dedicated embedding stage, extend bootstrap coverage, and expose adapter readiness to stabilize vector-driven features.
3. **Replay & operational guardrails.** Ship the admin endpoints, health checks, telemetry wiring, and automated tests so the sample meets the proposal's operations bar.
