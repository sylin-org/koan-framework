# S13.DocMind Refactoring Plan (Proposal Delta Alignment)

## 1. Proposal vs. Implementation Delta
- **Stage orchestration still lacks durable projections.** The proposal calls for a simple hosted worker that polls `SourceDocument` statuses, records every stage transition, and feeds diagnostics/MCP timelines directly from those events.【F:docs/chunks/S13-DocMind/03_ai_processing.md†L5-L39】【F:docs/chunks/S13-DocMind/02_entity_models.md†L169-L176】 The current worker now runs off a `DocumentProcessingJob` ledger but still pulls all jobs into memory via `DocumentProcessingJobRepository.GetPendingAsync`, and diagnostics read the entire ledger and document catalog for every request, so queue/timeline projections remain volatile and inefficient.【F:samples/S13.DocMind/Infrastructure/DocumentProcessingWorker.cs†L36-L121】【F:samples/S13.DocMind/Infrastructure/Repositories/DocumentProcessingJobRepository.cs†L25-L41】【F:samples/S13.DocMind/Services/ProcessingDiagnosticsService.cs†L38-L115】
- **Discovery services ignore the projection strategy.** The data blueprint expects repository-backed projections (`InsightCollection`, timeline feeds) rather than ad-hoc `.All()` scans so dashboards and MCP tooling can query efficiently.【F:docs/chunks/S13-DocMind/02_entity_models.md†L169-L182】【F:docs/chunks/S13-DocMind/03_ai_processing.md†L55-L59】 `DocumentInsightsService` and the diagnostics timeline still enumerate every document/insight in-memory, so none of the promised aggregation or paging behavior exists.【F:samples/S13.DocMind/Services/DocumentInsightsService.cs†L31-L146】【F:samples/S13.DocMind/Services/ProcessingDiagnosticsService.cs†L89-L139】
- **Vector and template flows remain local-only.** The proposal leans on optional Weaviate adapters, capability detection, and bootstrap checks so template suggestions ride on `Vector<T>.SearchAsync` with fallbacks.【F:docs/chunks/S13-DocMind/01_executive_overview.md†L16-L81】【F:docs/chunks/S13-DocMind/03_ai_processing.md†L18-L30】【F:docs/chunks/S13-DocMind/05_infrastructure.md†L5-L12】【F:docs/chunks/S13-DocMind/02_entity_models.md†L174-L182】 Today `TemplateSuggestionService` loads every embedding into memory and performs cosine math, while the bootstrapper only ensures the chunk index exists, leaving semantic profile vectors and adapter health unchecked.【F:samples/S13.DocMind/Services/TemplateSuggestionService.cs†L128-L196】【F:samples/S13.DocMind/Infrastructure/DocumentVectorBootstrapper.cs†L20-L36】
- **Operational hardening and quality gates trail the plan.** Infrastructure guidance lists storage/vector/model health probes and telemetry-rich boot reports, and the testing plan expects DocMind-specific unit/integration suites plus CLI/health flows.【F:docs/chunks/S13-DocMind/05_infrastructure.md†L90-L112】【F:docs/chunks/S13-DocMind/07_testing_ops.md†L1-L69】 The registrar still emits configuration summaries only, there are no health checks or readiness probes, and the repository hosts no S13-specific automated tests yet.【F:samples/S13.DocMind/Infrastructure/DocMindRegistrar.cs†L45-L79】【84e1e8†L1-L13】

## 2. Refactoring Themes

### Theme A – Durable stage ledger & diagnostics alignment
1. **Ledger queries, not full scans.** Replace `DocumentProcessingJobRepository.All()` usage with server-side filters (status, stage, due time) so the worker and diagnostics fetch targeted slices, supporting batch polling and queue paging without loading the entire table.【F:samples/S13.DocMind/Infrastructure/Repositories/DocumentProcessingJobRepository.cs†L25-L35】
2. **Resume-aware projections.** Persist per-stage breadcrumbs (started/completed timestamps, retry counters, token/latency metrics) on the job and emit richer `DocumentProcessingEvent` entries so diagnostics can present accurate queue/timeline summaries without recomputing from documents.【F:samples/S13.DocMind/Infrastructure/DocumentProcessingWorker.cs†L206-L319】
3. **Controller & CLI parity.** Extend `ProcessingController`/CLI to request specific stage resumes, guard concurrent executions, and hydrate responses from the new ledger queries to match the proposal’s targeted replay experience.【F:samples/S13.DocMind/Services/ProcessingDiagnosticsService.cs†L140-L219】【F:docs/chunks/S13-DocMind/03_ai_processing.md†L70-L75】

### Theme B – Discovery projections & analytics
1. **Repository-backed insights.** Introduce aggregation repositories (`InsightCollectionRepository`, `ProcessingQueueProjection`) that push filters/paging into the provider, retiring `.All()` scans in `DocumentInsightsService` and diagnostics timeline handlers.【F:samples/S13.DocMind/Services/DocumentInsightsService.cs†L31-L146】【F:samples/S13.DocMind/Services/ProcessingDiagnosticsService.cs†L89-L139】
2. **Materialized dashboards.** Generate the promised `InsightCollection`/similarity projections on a schedule (or on-demand refresh) so UI/MCP consumers issue a single query for “document at a glance,” aligning with the data blueprint.【F:docs/chunks/S13-DocMind/02_entity_models.md†L169-L182】
3. **API pagination & filtering.** Update `/processing/queue` and `/processing/timeline` endpoints to accept pagination windows, stage filters, and correlation IDs sourced from the repository projections, ensuring the UI and MCP clients can render timelines incrementally.【F:docs/chunks/S13-DocMind/04_api_ui_design.md†L8-L92】

### Theme C – Vector integration & template readiness
1. **Adapter-backed similarity.** Swap the manual cosine loop for `Vector<SemanticTypeEmbedding>.SearchAsync` (with vector gating) so similarity scoring happens inside Weaviate when available, and capture adapter latency plus fallback rationale in suggestion diagnostics.【F:samples/S13.DocMind/Services/TemplateSuggestionService.cs†L128-L196】【F:docs/chunks/S13-DocMind/03_ai_processing.md†L18-L30】
2. **Semantic profile bootstrap.** Extend the bootstrapper (or add a companion hosted task) to verify semantic profile embeddings exist, create missing vectors, and mark jobs as blocked when the adapter is offline, matching the multi-provider expectations.【F:samples/S13.DocMind/Infrastructure/DocumentVectorBootstrapper.cs†L20-L36】【F:docs/chunks/S13-DocMind/05_infrastructure.md†L5-L12】
3. **Vector-aware diagnostics.** Surface vector readiness and last-sync timestamps through the boot report and queue timeline so operators understand when template suggestions fall back to lexical heuristics.【F:samples/S13.DocMind/Infrastructure/DocMindRegistrar.cs†L45-L79】【F:docs/chunks/S13-DocMind/05_infrastructure.md†L90-L112】

### Theme D – Operations, health, and quality gates
1. **Boot report + health checks.** Augment `DocMindRegistrar.Describe` with live probes for storage, Ollama models, and vector adapters, and register ASP.NET health endpoints that mirror those probes so compose deployments expose real readiness signals.【F:samples/S13.DocMind/Infrastructure/DocMindRegistrar.cs†L45-L79】【F:docs/chunks/S13-DocMind/05_infrastructure.md†L90-L112】
2. **Telemetry-first instrumentation.** Wrap pipeline stages with OpenTelemetry spans and persist token/duration metrics on `DocumentProcessingEvent` entries, fulfilling the observability guidance from the AI processing plan.【F:docs/chunks/S13-DocMind/03_ai_processing.md†L55-L59】【F:samples/S13.DocMind/Infrastructure/DocumentProcessingWorker.cs†L206-L319】
3. **Testing harness delivery.** Stand up the DocMind unit/integration suites described in the testing plan (fake AI providers, upload→completion smoke, targeted retry tests) and wire them into CI so the rebuilt pipeline stays verifiable.【F:docs/chunks/S13-DocMind/07_testing_ops.md†L1-L69】【84e1e8†L1-L13】

## 3. Delivery Roadmap
1. **Iteration 0 – Ledger foundations.** Introduce filtered job queries, persist richer stage telemetry, and adapt diagnostics/controllers to the new projections while keeping the current worker behavior stable.
2. **Iteration 1 – Discovery projections.** Deliver repository-backed queue/timeline/insight projections, migrate services/controllers to them, and add pagination plus MCP/UI alignment.
3. **Iteration 2 – Vector completion.** Implement adapter-backed similarity, semantic profile bootstrapping, and vector-aware diagnostics so template suggestions finally match the proposal.
4. **Iteration 3 – Ops & quality gates.** Layer in health probes, telemetry, and the DocMind-focused test harness; update boot reports and documentation to close the operational checklist.

Each iteration should leave the sample runnable (feature flags acceptable) while incrementally erasing the remaining delta with the S13.DocMind proposal.
