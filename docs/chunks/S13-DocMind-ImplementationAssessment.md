# S13.DocMind Proposal vs. Implementation Assessment

## 1. Method
- Reviewed the S13.DocMind proposal package (`docs/chunks/S13-DocMind`) with emphasis on the domain blueprint, AI pipeline plan, and infrastructure guidance to understand the intended layered architecture.【F:docs/chunks/S13-DocMind/02_entity_models.md†L1-L176】【F:docs/chunks/S13-DocMind/03_ai_processing.md†L1-L83】【F:docs/chunks/S13-DocMind/05_infrastructure.md†L1-L112】
- Inspected the latest sample implementation in `samples/S13.DocMind`, covering domain models, pipeline services, controllers, and bootstrap code to map real behaviors and dependencies.【F:samples/S13.DocMind/Models/SourceDocument.cs†L1-L200】【F:samples/S13.DocMind/Services/DocumentAnalysisPipeline.cs†L1-L240】【F:samples/S13.DocMind/Controllers/DocumentsController.cs†L1-L136】【F:samples/S13.DocMind/Program.cs†L1-L36】

## 2. Proposal pillars (condensed)
1. **Domain parity** – Adopt `SourceDocument`, `DocumentChunk`, `DocumentInsight`, and `DocumentProcessingEvent` entities with Koan auto-adapter support and vector data delegated to dedicated `[VectorAdapter("weaviate")]` models.【F:docs/chunks/S13-DocMind/02_entity_models.md†L15-L175】
2. **Lean orchestration** – Replace bespoke channel queues with a single `DocumentProcessingWorker` that coordinates focused services (`TextExtractionService`, `VisionInsightService`, `InsightSynthesisService`, `TemplateSuggestionService`) through the Koan AI abstractions and emits persisted timeline events.【F:docs/chunks/S13-DocMind/03_ai_processing.md†L3-L66】
3. **Auto-registered infrastructure** – Keep `Program.cs` minimal with only `AddKoan()`, delegating all service wiring, options binding, and MCP configuration to auto-registrars that honor the `DocMind:` configuration hierarchy.【F:docs/chunks/S13-DocMind/05_infrastructure.md†L14-L28】
4. **Discovery built on DocMind entities** – Query analytics from the new document/insight collections (plus optional vector adapters) instead of the deprecated `File/Analysis/DocumentType` schema.【F:docs/chunks/S13-DocMind/02_entity_models.md†L3-L175】

## 3. Implementation snapshot (current state)
- Domain classes partially mirror the blueprint but keep inline embeddings and omit several properties the services expect (e.g., no `OriginalFileName`, `Summary`, or `Storage` on `SourceDocument`).【F:samples/S13.DocMind/Models/SourceDocument.cs†L19-L153】【F:samples/S13.DocMind/Services/DocumentIntakeService.cs†L76-L147】
- Pipeline logic still uses `DocumentWorkItem` entries tied to legacy `File`, `Analysis`, and `DocumentType` entities inside a channel-backed queue rather than the proposal’s `SourceDocument`-centric worker.【F:samples/S13.DocMind/Infrastructure/DocumentPipelineQueue.cs†L13-L121】【F:samples/S13.DocMind/Services/DocumentAnalysisPipeline.cs†L66-L205】
- `Program.cs` wires custom registrars (`AddDocMindProcessing`) and individual singletons manually, contradicting the auto-registrar approach.【F:samples/S13.DocMind/Program.cs†L12-L26】
- Controllers and analytics services still return DTOs based on legacy fields such as `DocumentInsight.Content` and `DocumentChunk.Channel`, which are absent in the current models.【F:samples/S13.DocMind/Controllers/DocumentsController.cs†L56-L132】【F:samples/S13.DocMind/Models/DocumentInsight.cs†L20-L77】【F:samples/S13.DocMind/Models/DocumentChunk.cs†L20-L78】

## 4. Gaps, contradictions, and aligned remediation

| Area | Proposal expectation | Current implementation | Impact | Recommended implementation |
|------|----------------------|------------------------|--------|----------------------------|
| Domain contracts | `SourceDocument` exposes processed summary while new embeddings live in `[VectorAdapter]` entities, and services rely on Koan auto adapters.【F:docs/chunks/S13-DocMind/02_entity_models.md†L18-L175】 | `SourceDocument` retains inline `Embedding` arrays and lacks properties (`OriginalFileName`, `Storage`, `Summary`) that services still reference, causing compile/runtime mismatches.【F:samples/S13.DocMind/Models/SourceDocument.cs†L87-L153】【F:samples/S13.DocMind/Services/DocumentIntakeService.cs†L76-L197】 | Upload flow can’t compile against the model; vector strategy diverges from Weaviate plan. | Align models with proposal (move embeddings to `DocumentChunkEmbedding`/`SemanticTypeEmbedding`, restore storage & summary value objects) and update services to consume the consolidated schema. |
| Processing timeline | Persist `DocumentProcessingEvent` rows with `Stage`, `Status`, detail/context payloads, and expose them through API timelines.【F:docs/chunks/S13-DocMind/03_ai_processing.md†L3-L58】【F:docs/chunks/S13-DocMind/02_entity_models.md†L116-L131】 | Entity lacks `Message`/`Context`, while services/controllers expect them; logging sink merely writes to ILogger without persistence.【F:samples/S13.DocMind/Models/DocumentProcessingEvent.cs†L15-L82】【F:samples/S13.DocMind/Services/DocumentIntakeService.cs†L185-L197】【F:samples/S13.DocMind/Services/DocumentProcessingEvents.cs†L5-L56】【F:samples/S13.DocMind/Controllers/DocumentsController.cs†L53-L66】 | Timeline endpoints cannot materialize required fields; events aren’t stored for diagnostics. | Extend the entity with the documented fields, replace the logger with a repository-backed event sink, and ensure controllers query persisted history. |
| Pipeline orchestration | Single `DocumentProcessingWorker` polls `SourceDocument` statuses and coordinates focused services without channel queues.【F:docs/chunks/S13-DocMind/03_ai_processing.md†L12-L44】 | Channel-backed `DocumentPipelineQueue` produces `DocumentWorkItem` records that hydrate `File`, `DocumentType`, and `Analysis` entities, none of which exist in the refactored domain.【F:samples/S13.DocMind/Infrastructure/DocumentPipelineQueue.cs†L13-L121】【F:samples/S13.DocMind/Services/DocumentAnalysisPipeline.cs†L66-L205】 | Background worker cannot run because required legacy types are absent; contradicts simplicity goal. | Replace queue + work item types with the proposed worker/processor services operating on `SourceDocument` statuses and new chunk/insight entities. |
| AI extraction & insights | Vision, text extraction, and structured insight services populate `DocumentChunk` and `DocumentInsight` with typed payloads and confidence metrics.【F:docs/chunks/S13-DocMind/03_ai_processing.md†L12-L44】 | Controllers expect fields (`Channel`, `Content`, `Confidence`) that no longer exist on models, and current services emit placeholder aggregation using legacy analysis metadata.【F:samples/S13.DocMind/Controllers/DocumentsController.cs†L68-L135】【F:samples/S13.DocMind/Models/DocumentInsight.cs†L23-L77】【F:samples/S13.DocMind/Models/DocumentChunk.cs†L20-L77】【F:samples/S13.DocMind/Services/DocumentAnalysisPipeline.cs†L176-L228】 | API responses break, and AI outputs don’t match promised structured payload format. | Rebuild extraction/insight services to write the proposal’s fields (e.g., `Heading`, `StructuredPayload`), adjust DTO mapping, and remove dependencies on legacy `Analysis` metadata. |
| Discovery services | Analytics should aggregate `SourceDocument`, `DocumentInsight`, and derived collections for dashboards.【F:docs/chunks/S13-DocMind/02_entity_models.md†L3-L175】 | `DocumentInsightsService` still queries `Models.File`, `Analysis`, and `DocumentType` despite those types not being part of the updated domain.【F:samples/S13.DocMind/Services/DocumentInsightsService.cs†L31-L200】 | Discovery endpoints will throw at runtime and can’t surface new insight constructs. | Rework insight aggregation to operate on DocMind entities and add the proposed `InsightCollection`/`SimilarityProjection` helpers. |
| Bootstrap & configuration | Minimal `Program.cs` with only `AddKoan()`; all service wiring, MCP configuration, and options binding handled automatically by framework auto-registrars.【F:docs/chunks/S13-DocMind/05_infrastructure.md†L14-L28】 | Current implementation already follows this pattern correctly with `AddKoan()` and `DocMindRegistrar` handling all service registration automatically.【F:samples/S13.DocMind/Program.cs†L1-L9】【F:samples/S13.DocMind/Infrastructure/DocMindRegistrar.cs†L22-L42】 | ✅ **Aligned** - Implementation correctly demonstrates "Reference = Intent" principle. | No changes needed - bootstrap pattern is exemplary. |

## 5. Additional contradictions & follow-on needs
- **Model/controller drift** – `DocumentsController` materializes `DocumentInsightResponse.Content`/`Channel` yet the entity exposes `Summary` and no channel enumeration, creating serialization failures even if queries succeed.【F:samples/S13.DocMind/Controllers/DocumentsController.cs†L68-L135】【F:samples/S13.DocMind/Models/DocumentInsight.cs†L23-L77】 Harmonize DTOs with the blueprint’s `Heading`/`Body`/`InsightChannel` shape.
- **Duplicated event types** – A second `DocumentProcessingEvent` record in `Services` namespace shadows the entity type and only logs to console, fragmenting telemetry logic.【F:samples/S13.DocMind/Services/DocumentProcessingEvents.cs†L5-L56】 Remove the duplicate and consolidate on the persisted entity plus repository-backed sink.
- **Vector plumbing** – Core entities continue to declare `[Vector]` properties even though the blueprint externalizes embeddings to dedicated classes for Weaviate integration, preventing optional vector deployments.【F:samples/S13.DocMind/Models/SourceDocument.cs†L87-L99】【F:samples/S13.DocMind/Models/DocumentChunk.cs†L45-L71】【F:samples/S13.DocMind/Models/DocumentInsight.cs†L39-L71】【F:docs/chunks/S13-DocMind/02_entity_models.md†L134-L161】 Move embeddings to the adapter entities and let core models stay provider-agnostic.
- **Legacy dependency surface** – Services such as `DocumentAnalysisPipeline` import `Koan.Data.Core.File`, `DocumentType`, and `Analysis` models, which aren’t defined in the updated sample and contradict the “break-and-rebuild” mandate.【F:samples/S13.DocMind/Services/DocumentAnalysisPipeline.cs†L66-L205】 Replace with orchestrations that operate exclusively on DocMind models.

## 6. Prioritized remediation sequence
1. **Fix the domain contracts** – Bring entity/DTO schemas into alignment (storage info, summary value object, insight payloads, vector adapters) so the rest of the stack compiles.
2. **Replace the queue pipeline** – Implement the proposal's `DocumentProcessingWorker`/`DocumentProcessor` orchestrator, updating services to hydrate `DocumentChunk`/`DocumentInsight` and emit persisted events.
3. **Modernize analytics** – Rework `DocumentInsightsService` and related controllers to query the new domain models and aggregate insights.
4. **Layer in AI/vision upgrades** – Once the pipeline operates on the correct models, integrate Koan AI prompts for OCR, vision, and structured insight synthesis, persisting results in the new schema.

**Note**: Bootstrap pattern is already correct and exemplary - no changes needed.

This sequence re-establishes the foundational contracts before rebuilding orchestration and AI capabilities, matching the plan laid out in the S13.DocMind proposal while eliminating contradictions in the current code.
