# S13.DocMind Proposal vs. Implementation Assessment

## 1. Method
- Reviewed the S13.DocMind proposal package (`docs/chunks/S13-DocMind`) with emphasis on the domain blueprint, AI pipeline plan, and infrastructure guidance to understand the intended layered architecture.【F:docs/chunks/S13-DocMind/02_entity_models.md†L1-L176】【F:docs/chunks/S13-DocMind/03_ai_processing.md†L1-L83】【F:docs/chunks/S13-DocMind/05_infrastructure.md†L1-L112】
- Inspected the latest sample implementation in `samples/S13.DocMind`, covering domain models, pipeline services, controllers, and bootstrap code to map real behaviors and dependencies.【F:samples/S13.DocMind/Models/SourceDocument.cs†L1-L200】【F:samples/S13.DocMind/Infrastructure/DocumentProcessingWorker.cs†L1-L470】【F:samples/S13.DocMind/Controllers/DocumentsController.cs†L1-L136】【F:samples/S13.DocMind/Program.cs†L1-L36】

## 2. Proposal pillars (condensed)
1. **Domain parity** – Adopt `SourceDocument`, `DocumentChunk`, `DocumentInsight`, and `DocumentProcessingEvent` entities with Koan auto-adapter support and vector data delegated to dedicated `[VectorAdapter("weaviate")]` models.【F:docs/chunks/S13-DocMind/02_entity_models.md†L15-L175】
2. **Lean orchestration** – Replace bespoke channel queues with a single `DocumentProcessingWorker` that coordinates focused services (`TextExtractionService`, `VisionInsightService`, `InsightSynthesisService`, `TemplateSuggestionService`) through the Koan AI abstractions and emits persisted timeline events.【F:docs/chunks/S13-DocMind/03_ai_processing.md†L3-L66】
3. **Auto-registered infrastructure** – Keep `Program.cs` minimal with only `AddKoan()`, delegating all service wiring, options binding, and MCP configuration to auto-registrars that honor the `DocMind:` configuration hierarchy.【F:docs/chunks/S13-DocMind/05_infrastructure.md†L14-L28】
4. **Discovery built on DocMind entities** – Query analytics from the new document/insight collections (plus optional vector adapters) instead of the deprecated `File/Analysis/DocumentType` schema.【F:docs/chunks/S13-DocMind/02_entity_models.md†L3-L175】

## 3. Implementation snapshot (current state)
- `SourceDocument`, chunk, and insight entities now mirror the proposal closely, and the new `DocumentProcessingWorker` polls a persisted `DocumentProcessingJob` ledger so stage transitions, retries, and resumptions survive restarts.【F:samples/S13.DocMind/Infrastructure/DocumentProcessingWorker.cs†L1-L470】【F:samples/S13.DocMind/Models/DocumentProcessingJob.cs†L1-L120】【F:samples/S13.DocMind/Services/DocumentIntakeService.cs†L1-L210】 Stage-aware metrics and replay endpoints still need to land in diagnostics, but the queue is no longer volatile.
- Discovery services pull entire collections into memory for every request (`SourceDocument.All`, `DocumentInsight.All`) instead of querying aggregated projections, limiting scalability and deviating from the data-access blueprint.【F:samples/S13.DocMind/Services/DocumentInsightsService.cs†L29-L146】
- Template suggestions still load every semantic profile embedding locally and compute cosine similarity instead of delegating to the vector adapter search APIs expected by the proposal.【F:samples/S13.DocMind/Services/TemplateSuggestionService.cs†L124-L195】
- Operational scaffolding stops at configuration dumps in the registrar; the boot report omits the health checks, adapter readiness probes, and telemetry hooks promised in the infrastructure plan, and there is still no S13.DocMind-focused automated test suite registered under `tests/`.【F:samples/S13.DocMind/Infrastructure/DocMindRegistrar.cs†L46-L80】【e8959d†L1-L11】

## 4. Gaps, contradictions, and aligned remediation

| Area | Proposal expectation | Current implementation | Impact | Recommended implementation |
|------|----------------------|------------------------|--------|----------------------------|
| Stage-aware orchestration | A single `DocumentProcessingWorker` polls `SourceDocument` state, advancing one stage at a time with persisted progress markers so diagnostics can resume the exact failure point.【F:docs/chunks/S13-DocMind/03_ai_processing.md†L12-L66】 | `DocumentProcessingWorker` now drives each stage against a durable `DocumentProcessingJob`, recording stage metadata and rescheduling retries with exponential backoff.【F:samples/S13.DocMind/Infrastructure/DocumentProcessingWorker.cs†L1-L470】【F:samples/S13.DocMind/Models/DocumentProcessingJob.cs†L1-L120】 Targeted replay APIs and richer timeline summaries still need to surface in diagnostics. | Expose stage-scoped replay endpoints, surface queue projections from the job ledger, and wire additional diagnostics/telemetry around each resume path. |
| Discovery & analytics | Dashboards query repository-backed projections (`InsightCollection`, `SimilarityProjection`) rather than loading entire tables into memory.【F:docs/chunks/S13-DocMind/02_entity_models.md†L3-L175】 | `DocumentInsightsService` and `DocumentAggregationService` call `SourceDocument.All()`/`DocumentInsight.All()` for every request, then aggregate in-memory.【F:samples/S13.DocMind/Services/DocumentInsightsService.cs†L29-L146】 | Queries become O(n) scans, blocking scale-out and conflicting with the data-access plan. | Introduce repository filters/aggregations, materialize proposal-defined projections, and update services/controllers to consume them. |
| Vector-driven classification | Weaviate (or adapter) search powers template/profile suggestions, capturing latency/telemetry as part of the AI stage.【F:docs/chunks/S13-DocMind/03_ai_processing.md†L38-L66】 | `TemplateSuggestionService` reads every profile embedding, computes cosine similarity locally, and never records adapter metrics.【F:samples/S13.DocMind/Services/TemplateSuggestionService.cs†L124-L195】 | Memory-heavy scans and missing telemetry prevent Weaviate adoption and diagnostics. | Delegate suggestions to `Vector<SemanticTypeEmbedding>.SearchAsync`, persist adapter metrics, and bootstrap missing profile embeddings, following the S5.Recs pattern that gates on `Vector<T>.IsAvailable`, invokes `Vector<T>.Search` for primary retrieval, and falls back to non-vector flows when adapters are offline.【F:samples/S5.Recs/Services/RecsService.cs†L96-L149】 |
| Operations & quality gates | Registrar emits health probes, adapter readiness, and telemetry wiring; dedicated S13.DocMind tests validate pipeline behavior.【F:docs/chunks/S13-DocMind/05_infrastructure.md†L40-L112】【F:docs/chunks/S13-DocMind/07_testing_ops.md†L1-L110】 | Boot report only lists configuration strings, no health checks or telemetry hooks, and there is no DocMind-specific test project in `tests/`.【F:samples/S13.DocMind/Infrastructure/DocMindRegistrar.cs†L46-L80】【e8959d†L1-L11】 | Operators lack readiness signals, CI has no coverage, and DX goals from the proposal remain unmet. | Extend the registrar with health/telemetry registration, add diagnostics endpoints, and introduce the dedicated integration/unit test suites. |

## 5. Additional contradictions & follow-on needs
- **Stage telemetry gaps** – Intake and diagnostics now schedule persisted jobs but still emit limited contextual events; retries log a generic “retry requested” entry without exposing the stage target or prior failure metadata.【F:samples/S13.DocMind/Services/ProcessingDiagnosticsService.cs†L1-L240】【F:samples/S13.DocMind/Services/DocumentIntakeService.cs†L1-L210】 Expand event payloads to capture requested stages, retry cadence, and job identifiers so tooling can surface richer timelines.
- **Vector bootstrap limitations** – `DocumentVectorBootstrapper` only checks chunk embeddings and never validates semantic profile vectors, so template suggestions can silently degrade.【F:samples/S13.DocMind/Infrastructure/DocumentVectorBootstrapper.cs†L1-L34】 Expand bootstrap coverage to include profile embeddings, emit adapter readiness diagnostics, and surface vector stats akin to S5.Recs’ `SeedService` which uses `Vector<T>.Stats` to validate availability.【F:samples/S5.Recs/Services/SeedService.cs†L288-L303】
- **Telemetry-lite registrar** – `DocMindRegistrar.Describe` surfaces configuration strings but omits OpenTelemetry wiring or ASP.NET health checks promised in the infrastructure guide.【F:samples/S13.DocMind/Infrastructure/DocMindRegistrar.cs†L46-L80】【F:docs/chunks/S13-DocMind/05_infrastructure.md†L40-L112】 Wire up health checks, trace instrumentation, and boot-failure gates to match the documented ops story.

## 6. Prioritized remediation sequence
1. **Ship the stage-aware worker** – Land the persisted job ledger plus polling worker, retire the channel queue, and guarantee stage-level resume/metrics fidelity.
2. **Refit discovery on projections** – Introduce repository-backed queries, `InsightCollection` materializations, and timeline pagination to unlock analytics scale.
3. **Finish vector integration** – Delegate profile suggestions to the adapter search APIs, backfill profile embeddings, and capture vector telemetry for diagnostics.
4. **Close operations gaps** – Add the documented health checks, telemetry hooks, and dedicated test suites so the sample meets the infrastructure/testing blueprint.

**Note**: Bootstrap pattern is already correct and exemplary - no changes needed.

This sequence re-establishes the foundational contracts before rebuilding orchestration and AI capabilities, matching the plan laid out in the S13.DocMind proposal while eliminating contradictions in the current code.
